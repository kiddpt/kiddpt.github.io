<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device=width, initial-scale=1.0">
  <title>Comprehensive Triage Framework</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    h1, h2, h3 {
      color: #0056b3;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    select, input[type="number"], input[type="text"], input[type="range"], button, textarea {
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #0056b3;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #004494;
    }
    table {
      margin-top: 20px;
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .pill {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      color: white;
      font-weight: bold;
    }
    .criticality-0, .timing-0, .businessScale-0 {
      background-color: #f0f0f0; /* very light gray */
      color: #333;
    }
    .criticality-1, .timing-1, .businessScale-1 {
      background-color: #d4edda; /* light green */
      color: #155724;
    }
    .criticality-2, .timing-2, .businessScale-2 {
      background-color: #fff3cd; /* light yellow */
      color: #856404;
    }
    .criticality-3, .timing-3, .businessScale-3 {
      background-color: #ffeeba; /* light orange */
      color: #856404;
    }
    .criticality-4, .timing-4, .businessScale-4 {
      background-color: #f8d7da; /* light pink */
      color: #721c24;
    }
    .criticality-5, .timing-5, .businessScale-5 {
      background-color: #f5c6cb; /* light red */
      color: #721c24;
    }
    .flex-container {
      display: flex;
      gap: 20px;
    }
    .flex-item-1 {
      flex: 3;
      min-width: 900px;
    }
    .flex-item-2 {
      flex: 1;
      min-width: 700px;
    }
    .sticky-sidebar {
      position: sticky;
      top: 20px;
      background-color: #fff;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      height: fit-content;
      overflow-y: auto;
    }
    .table-button {
      padding: 5px;
      width: auto;
      background-color: #d9534f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .table-button:hover {
      background-color: #c9302c;
    }
    textarea {
      resize: auto;
    }
    .parameter-pair {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .parameter-pair input[type="number"] {
      width: 60px;
      margin-right: 10px;
    }
    .parameter-pair input[type="text"] {
      width: 2600px;
      margin-right: 10px;
    }
    .parameter-pair button {
      margin-left: 10px;
      padding: 5px 10px;
      font-size: 12px;
    }
    .tabs, .third-tabs {
      display: flex;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .tab, .third-tab {
      padding: 10px;
      background-color: #f2f2f2;
      border: 1px solid #ddd;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
    }
    .tab.active {
      background-color: #fff;
      border-bottom: none;
    }
    .tab-content, .third-tab-content {
      display: none;
      border: 1px solid #ddd;
      border-radius: 0 4px 4px 4px;
      padding: 20px;
      background-color: #fff;
    }
    .tab-content.active, .third-tab-content.active {
      display: block;
    }
    .nested-tabs {
      display: flex;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .nested-tab {
      padding: 10px;
      background-color: #f2f2f2;
      border: 1px solid #ddd;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
    }
    .nested-tab.active {
      background-color: #fff;
      border-bottom: none;
    }
    .nested-tab-content {
      display: none;
      border: 1px solid #ddd;
      border-radius: 0 4px 4px 4px;
      padding: 20px;
      background-color: #fff;
    }
    .nested-tab-content.active {
      display: block;
    }
    .add-description-button {
      padding: 5px 10px;
      font-size: 12px;
      margin-top: 10px;
    }
    .export-import-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .factor-group {
      margin-bottom: 20px;
    }
    .priority-level {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      color: white;
      font-weight: bold;
    }
    .priority-high {
      background-color: #d9534f; /* red */
    }
    .priority-medium {
      background-color: #f0ad4e; /* orange */
    }
    .priority-low {
      background-color: #5cb85c; /* green */
    }
    .add-parameter-button {
      padding: 5px 10px;
      font-size: 12px;
      margin-top: 10px;
    }
    .reset-parameters-button, #resetFactorsButton {
      margin-top: 10px;
      background-color: #d9534f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .reset-parameters-button:hover {
      background-color: #c9302c;
    }
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 {
      color: #1e90ff; /* blue */
    }
    body.dark-mode select, body.dark-mode input[type="number"], body.dark-mode input[type="text"], body.dark-mode input[type="range"], body.dark-mode button, body.dark-mode textarea {
      background-color: #333;
      color: #e0e0e0;
      border: 1px solid #444;
    }
    body.dark-mode button {
      background-color: #1e90ff; /* blue */
      color: #121212;
    }
    body.dark-mode button:hover {
      background-color: #1c86ee; /* darker blue */
    }
    body.dark-mode table {
      background-color: #333;
      color: #e0e0e0;
    }
    body.dark-mode table, body.dark-mode th, body.dark-mode td {
      border: 1px solid #444;
    }
    body.dark-mode th {
      background-color: #444;
    }
    body.dark-mode .pill {
      color: #121212;
    }
    body.dark-mode .criticality-0, body.dark-mode .timing-0, body.dark-mode .businessScale-0 {
      background-color: #444;
    }
    body.dark-mode .criticality-1, body.dark-mode .timing-1, body.dark-mode .businessScale-1 {
      background-color: #388e3c;
    }
    body.dark-mode .criticality-2, body.dark-mode .timing-2, body.dark-mode .businessScale-2 {
      background-color: #fbc02d;
    }
    body.dark-mode .criticality-3, body.dark-mode .timing-3, body.dark-mode .businessScale-3 {
      background-color: #ffa000;
    }
    body.dark-mode .criticality-4, body.dark-mode .timing-4, body.dark-mode .businessScale-4 {
      background-color: #d32f2f;
    }
    body.dark-mode .criticality-5, body.dark-mode .timing-5, body.dark-mode .businessScale-5 {
      background-color: #c62828;
    }
    body.dark-mode .sticky-sidebar {
      background-color: #333;
      border: 1px solid #444;
    }
    body.dark-mode .table-button {
      background-color: #d32f2f;
      color: #e0e0e0;
    }
    body.dark-mode .table-button:hover {
      background-color: #b71c1c;
    }
    body.dark-mode .tab {
      background-color: #444;
      color: #e0e0e0;
    }
    body.dark-mode .tab.active {
      background-color: #333;
    }
    body.dark-mode .nested-tab {
      background-color: #444;
      color: #e0e0e0;
    }
    body.dark-mode .nested-tab.active {
      background-color: #333;
    }
    body.dark-mode .third-tab {
      background-color: #444;
      color: #e0e0e0;
    }
    body.dark-mode .third-tab.active {
      background-color: #333;
    }
    body.dark-mode .tab-content, body.dark-mode .nested-tab-content, body.dark-mode .third-tab-content {
      background-color: #333;
      border: 1px solid #444;
    }
    body.dark-mode .priority-high {
      background-color: #d32f2f;
    }
    body.dark-mode .priority-medium {
      background-color: #fbc02d;
    }
    body.dark-mode .priority-low {
      background-color: #388e3c;
    }
    .third-tab {
      padding: 10px;
      background-color: #f2f2f2;
      border: 1px solid #ddd;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
    }
    .third-tab.active {
      background-color: #fff;
      border-bottom: none;
    }
    .third-tab-content {
      display: none;
      border: 1px solid #ddd;
      border-radius: 0 4px 4px 4px;
      padding: 20px;
      background-color: #fff;
    }
    .third-tab-content.active {
      display: block;
    }
    .save-state-button {
      margin-top: 10px;
      background-color: #5cb85c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .save-state-button:hover {
      background-color: #4cae4c;
    }
    .save-state-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .reset-to-saved-state-button {
      margin-top: 10px;
      background-color: #d9534f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .reset-to-saved-state-button:hover {
      background-color: #c9302c;
    }
    .reset-to-saved-state-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .save-state-button {
      margin-top: 10px;
      background-color: #5cb85c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .save-state-button:hover {
      background-color: #4cae4c;
    }
    .save-state-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    body.dark-mode .reset-to-saved-state-button {
      background-color: #d9534f;
      color: #e0e0e0;
    }
    body.dark-mode .reset-to-saved-state-button:hover {
      background-color: #c9302c;
    }
    body.dark-mode .reset-to-saved-state-button:disabled {
      background-color: #444;
      cursor: not-allowed;
    }
    body.dark-mode .save-state-button {
      background-color: #5cb85c;
      color: #e0e0e0;
    }
    body.dark-mode .save-state-button:hover {
      background-color: #4cae4c;
    }
    body.dark-mode .save-state-button:disabled {
      background-color: #444;
      cursor: not-allowed;
    }
    .reset-to-saved-state-button:hover {
      background-color: #c9302c;
    }
    .reset-to-saved-state-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .chart-container {
      display: flex;
      justify-content: space-around;
    }
    .chart-container canvas {
      width: 200px !important;
      height: 200px !important;
    }
    .chart-title {
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
    }
    .security {
      background-color: #e06666; /* Security */
    }
    .clientExperience {
      background-color: #6d9eeb; /* Client Experience */
    }
    .productDelivery {
      background-color: #8e7cc3; /* Product Delivery */
    }
    .performanceReliability {
      background-color: #93c47d; /* Performance & Reliability */
    }
    .dataEngineering {
      background-color: #f6b26b; /* Data Engineering */
    }
    .costOptimization {
      background-color: #cc4125; /* Cost Optimization */
    }
    .description-container {
      margin-top: 20px;
    }
    .copy-button {
      margin-top: 10px;
      background-color: #6c757d; /* gray */
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .copy-button:hover {
      background-color: #5a6268;
    }
    .edit-button, .delete-button {
      padding: 5px;
      width: auto;
      background-color: #f0ad4e;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .edit-button:hover {
      background-color: #ec971f;
    }
    .delete-button {
      background-color: #d9534f;
    }
    .delete-button:hover {
      background-color: #c9302c;
    }
    .save-entry-button {
      background-color: #007bff; /* blue */
    }
    .save-entry-button:hover {
      background-color: #0056b3;
    }
    .update-entry-button {
      background-color: #f0ad4e; /* orange */
    }
    .update-entry-button:hover {
      background-color: #ec971f;
    }
    .cancel-update-button {
      background-color: #d9534f; /* red */
    }
    .cancel-update-button:hover {
      background-color: #c9302c;
    }
    .highlight-row {
      background-color: #fff9c4; /* light yellow */
    }
    .positive-change {
      color: green;
    }
    .negative-change {
      color: red;
    }
    .icon-up {
      color: green;
      margin-left: 5px;
    }
    .icon-down {
      color: red;
      margin-left: 5px;
    }
    .auth-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
    }
    .auth-buttons button {
      padding: 5px 10px;
      font-size: 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .auth-buttons button:hover {
      background-color: #0056b3;
    }
    .active-users {
      position: absolute;
      top: 54px;
      right: 10px;
      display: flex;
      gap: 10px;
    }
    .user-badge {
      padding: 5px 10px;
      font-size: 12px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
    }
    .user-badge.hidden {
      background-color: rgba(40, 167, 69, 0.1); /* transparent green */
    }
    .user-badge.inactive {
      background-color: rgba(40, 167, 69, 0.5); /* transparent green */
    }
    #loadNamespaceButton:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .status-dropdown {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .status-not-started {
      background-color: #f0f0f0; /* very light gray */
      color: #333;
    }
    .status-wip {
      background-color: #f0ad4e; /* orange */
      color: white;
    }
    .status-deployed {
      background-color: #5cb85c; /* green */
      color: white;
    }
    .status-on-hold {
      background-color: #d9534f; /* red */
      color: white;
    }
    .status-cancelled {
      background-color: #6c757d; /* gray */
      color: white;
    }
    .icon {
      width: 16px;
      height: 16px;
      margin-left: 5px;
      cursor: pointer;
    }
    .namespace-select {
      margin-top: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="auth-buttons">
    <button id="googleSignInButton" class="btn btn-primary">Sign in with Google</button>
  </div>

  <div id="activeUsers" class="active-users"></div>

  <div id="mainContent" style="display: none;">
    <h1>Comprehensive Triage Framework</h1>
    <div class="flex-container">
      <div class="flex-item-1">
        <button id="toggleViewButton">Show Permutation Table</button>
        <button id="toggleDarkModeButton">Toggle Dark Mode</button>
        
        <div id="calculatorView">
          <label for="categorySelect">Select Category:</label>
          <select id="categorySelect">
            <option value="clientExperience">Client Experience</option>
            <option value="productDelivery">Product Delivery</option>
            <option value="security">Security</option>
            <option value="costOptimization">Cost Optimization</option>
            <option value="performanceReliability">Performance & Reliability</option>
            <option value="dataEngineering">Data Engineering</option>
          </select>

          <!-- Client Experience Fields -->
          <div id="clientExperienceFields" class="categoryFields">
            <label for="showstopper">Showstopper (0-5):</label>
            <select id="showstopper">
              <!-- Options will be populated by JavaScript -->
            </select>
            
            <label for="frequency">Frequency (0-5):</label>
            <select id="frequency">
              <!-- Options will be populated by JavaScript -->
            </select>
            
            <label for="timeSpent">Time Spent (0-5):</label>
            <select id="timeSpent">
              <!-- Options will be populated by JavaScript -->
            </select>

            <label for="clientExperienceBusinessScale">Business Scale (%):</label>
            <input type="number" id="clientExperienceBusinessScale" min="0" value="10">
          </div>

          <!-- Product Delivery Fields -->
          <div id="productDeliveryFields" class="categoryFields" style="display: none;">
            <label for="dealbreaker">Dealbreaker (0-5):</label>
            <select id="dealbreaker">
              <!-- Options will be populated by JavaScript -->
            </select>
            
            <label for="projectTime">Project Completion Time (0-5):</label>
            <select id="projectTime">
              <!-- Options will be populated by JavaScript -->
            </select>
            
            <label for="clientTraffic">Expected Client Traffic Increase (%):</label>
            <input type="number" id="clientTraffic" min="0" value="10">
          </div>

          <!-- Security Fields -->
          <div id="securityFields" class="categoryFields" style="display: none;">
            <label for="companyShutdown">Company Shutdown (0-5):</label>
            <select id="companyShutdown">
              <!-- Options will be populated by JavaScript -->
            </select>
            
            <label for="likelihood">Likelihood of Occurrence (0-5):</label>
            <select id="likelihood">
              <!-- Options will be populated by JavaScript -->
            </select>

            <label for="securityBusinessScale">Business Scale (%):</label>
            <input type="number" id="securityBusinessScale" min="0" value="10">
          </div>

          <!-- Cost Optimization Fields -->
          <div id="costOptimizationFields" class="categoryFields" style="display: none;">
            <label for="implementationTime">Implementation Time (0-5):</label>
            <select id="implementationTime">
              <!-- Options will be populated by JavaScript -->
            </select>

            <label for="costOptimizationBusinessScale">Business Scale ($):</label>
            <input type="number" id="costOptimizationBusinessScale" min="0" value="2000">
          </div>

          <!-- Performance & Reliability Fields -->
          <div id="performanceReliabilityFields" class="categoryFields" style="display: none;">
            <label for="severity">Severity (0-5):</label>
            <select id="severity">
              <!-- Options will be populated by JavaScript -->
            </select>
            
            <label for="developmentTime">Development Time (0-5):</label>
            <select id="developmentTime">
              <!-- Options will be populated by JavaScript -->
            </select>

            <label for="performanceReliabilityBusinessScale">Business Scale (%):</label>
            <input type="number" id="performanceReliabilityBusinessScale" min="0" value="10">
          </div>

          <!-- Data Engineering Fields -->
          <div id="dataEngineeringFields" class="categoryFields" style="display: none;">
            <label for="dataEngineeringSeverity">Severity (0-5):</label>
            <select id="dataEngineeringSeverity">
              <!-- Options will be populated by JavaScript -->
            </select>
            
            <label for="dataEngineeringDevelopmentTime">Development Time (0-5):</label>
            <select id="dataEngineeringDevelopmentTime">
              <!-- Options will be populated by JavaScript -->
            </select>

            <label for="dataEngineeringBusinessScale">Business Scale (%):</label>
            <input type="number" id="dataEngineeringBusinessScale" min="0" value="10">
          </div>

          <div id="calculatedScore"></div>
          <div id="priorityLevel"></div>
          <div class="description-container">
            <label for="projectDescription">Project Description:</label>
            <textarea id="projectDescription" rows="4"></textarea>
          </div>
          <label for="googleDocLink">Google Doc Link:</label>
          <input type="text" id="googleDocLink" placeholder="Enter Google Doc link">
          <label for="jiraTicketLink">Jira Ticket Link:</label>
          <input type="text" id="jiraTicketLink" placeholder="Enter Jira Ticket link">
          <div id="namespaceSelectContainer" class="namespace-select" style="display: none;">
            <label for="namespaceSelect">Select Namespace:</label>
            <select id="namespaceSelect"></select>
          </div>
          <button id="saveEntryButton" class="save-entry-button">Save Entry</button>
          <button id="cancelUpdateButton" class="cancel-update-button" style="display: none;">Cancel Update</button>
          
          <!-- Add filter inputs -->
          <button id="toggleFiltersButton">Show Filters</button>
          <div id="filtersRow" class="filters-row" style="display: none;">
            <div class="description-container">
              <label for="filterInput">Search Entries:</label>
              <input type="text" id="filterInput" placeholder="Type to filter entries..." style="width: 300px;">
            </div>
            <div class="description-container">
              <label for="categoryFilter">Filter by Category:</label>
              <select id="categoryFilter" multiple>
                <option value="Client Experience">Client Experience</option>
                <option value="Product Delivery">Product Delivery</option>
                <option value="Security">Security</option>
                <option value="Cost Optimization">Cost Optimization</option>
                <option value="Performance & Reliability">Performance & Reliability</option>
                <option value="Data Engineering">Data Engineering</option>
              </select>
              <button id="clearCategoryFilter" class="clear-filter-button">Clear</button>
            </div>
            <div class="description-container">
              <label for="criticalityFilter">Filter by Criticality:</label>
              <select id="criticalityFilter" multiple>
                <option value="0">0 - No Impact</option>
                <option value="1">1 - Not Critical</option>
                <option value="2">2 - Low Criticality</option>
                <option value="3">3 - Moderate Criticality</option>
                <option value="4">4 - High Criticality</option>
                <option value="5">5 - Total Stop</option>
              </select>
              <button id="clearCriticalityFilter" class="clear-filter-button">Clear</button>
            </div>
            <div class="description-container">
              <label for="timingFilter">Filter by Timing:</label>
              <select id="timingFilter" multiple>
                <option value="0">0 - Never</option>
                <option value="1">1 - Very Unlikely</option>
                <option value="2">2 - Unlikely</option>
                <option value="3">3 - Possible</option>
                <option value="4">4 - Likely</option>
                <option value="5">5 - Very Likely</option>
              </select>
              <button id="clearTimingFilter" class="clear-filter-button">Clear</button>
            </div>
            <div class="description-container">
              <label for="businessScaleFilter">Filter by Business Scale:</label>
              <select id="businessScaleFilter" multiple>
                <option value="0">0</option>
                <option value="20">20</option>
                <option value="40">40</option>
                <option value="60">60</option>
                <option value="80">80</option>
                <option value="100">100</option>
              </select>
              <button id="clearBusinessScaleFilter" class="clear-filter-button">Clear</button>
            </div>
            <div class="description-container">
              <label for="businessScaleFilter">Filter by Status:</label>
              <select id="statusFilter" class="status-dropdown" multiple>
                <option value="Not Started">Not Started</option>
                <option value="WIP">WIP</option>
                <option value="Deployed">Deployed</option>
                <option value="On Hold">On Hold</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div class="description-container">
              <button id="clearAllFiltersButton" class="clear-filter-button">Clear All Filters</button>
            </div>
          </div>
          
          <div class="description-container">
            <label for="namespaceInput">Namespace:</label>
            <input type="text" id="namespaceInput" placeholder="Enter namespace..." style="width: 300px;">
            <button id="loadNamespaceButton">Load Namespace</button>
          </div>
          
          <table id="entriesTable">
            <thead>
              <tr>
                <th>Description</th>
                <th>Category</th>
                <th>Criticality</th>
                <th>Timing</th>
                <th>Business Scale</th>
                <th>Score</th>
                <th width="130px">Priority Level</th>
                <th width="120px">Status</th>
                <th id="namespace-header" width="120px">Namespace</th>
                <th width="90px">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button id="copyTableButton" class="copy-button">Copy Table</button>
        </div>

        <div id="permutationTableView" style="display: none;">
          <h2>Permutation Table</h2>
          <button id="resetFiltersButton">Reset Filters</button>
          <div id="permutationCount"></div> <!-- New element to display the count -->
          <div class="chart-container">
            <div>
              <canvas id="lowPriorityChart" width="400" height="200"></canvas>
              <div class="chart-title">Low Priority</div>
            </div>
            <div>
              <canvas id="mediumPriorityChart" width="400" height="200"></canvas>
              <div class="chart-title">Medium Priority</div>
            </div>
            <div>
              <canvas id="highPriorityChart" width="400" height="200"></canvas>
              <div class="chart-title">High Priority</div>
            </div>
          </div>
          <table id="permutationTable">
            <thead>
              <tr>
                <th style="width: 50px;">Category</th>
                <th style="width: 150px;">Criticality</th>
                <th style="width: 150px;">Timing</th>
                <th style="width: 30px;">Business Scale</th>
                <th style="width: 30px;">Score</th>
                <th style="width: 30px;">Priority Level</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="flex-item-2 sticky-sidebar">
          <div class="export-import-buttons">
              <button id="exportStateButton">Export State</button>
              <input type="file" id="importStateInput" style="display: none;">
              <button id="importStateButton">Import State</button>
          </div>
          <button id="saveStateButton" class="save-state-button" disabled>Save State</button>
          <button id="resetStateButton" class="reset-to-saved-state-button" disabled>Reset to Saved State</button>
        <div class="tabs">
          <div class="tab active" data-tab="factors">Factors</div>
          <div class="tab" data-tab="parameters">Parameters</div>
        </div>
        <div id="factors" class="tab-content active">
          <div class="nested-tabs">
            <div class="nested-tab active" data-tab="clientExperienceFactors">Client Experience</div>
            <div class="nested-tab" data-tab="productDeliveryFactors">Product Delivery</div>
            <div class="nested-tab" data-tab="securityFactors">Security</div>
            <div class="nested-tab" data-tab="costOptimizationFactors">Cost Optimization</div>
            <div class="nested-tab" data-tab="performanceReliabilityFactors">Performance & Reliability</div>
            <div class="nested-tab" data-tab="dataEngineeringFactors">Data Engineering</div>
          </div>
          <div id="clientExperienceFactors" class="nested-tab-content active">
            <h2>Client Experience Factors</h2>
            <div class="factor-group">
              <label for="clientExperienceCriticalityFactor">Criticality Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="clientExperienceCriticalityFactorValue" min="0" max="10" value="0.5" step="0.01" style="width: 150px;">
                <input type="range" id="clientExperienceCriticalityFactor" min="0" max="10" value="0.5" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="clientExperienceTimingFactor">Timing Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="clientExperienceTimingFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 150px;">
                <input type="range" id="clientExperienceTimingFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="clientExperienceBusinessScaleFactor">Business Scale Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="clientExperienceBusinessScaleFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 150px;">
                <input type="range" id="clientExperienceBusinessScaleFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
            </div>
          </div>
          <div id="productDeliveryFactors" class="nested-tab-content">
            <h2>Product Delivery Factors</h2>
            <div class="factor-group">
              <label for="productDeliveryCriticalityFactor">Criticality Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="productDeliveryCriticalityFactorValue" min="0" max="10" value="0.5" step="0.01" style="width: 150px;">
                <input type="range" id="productDeliveryCriticalityFactor" min="0" max="10" value="0.5" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="productDeliveryTimingFactor">Timing Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="productDeliveryTimingFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 150px;">
                <input type="range" id="productDeliveryTimingFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="productDeliveryBusinessScaleFactor">Business Scale Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="productDeliveryBusinessScaleFactorValue" min="0" max="10" value="1.25" step="0.01" style="width: 150px;">
                <input type="range" id="productDeliveryBusinessScaleFactor" min="0" max="10" value="1.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="productDeliveryBusinessScaleLimit">Product Delivery Business Scale Limit (%):</label>
              <input type="number" id="productDeliveryBusinessScaleLimit" min="0" max="100" value="20" style="width: 150px;">
            </div>
          </div>
          <div id="securityFactors" class="nested-tab-content">
            <h2>Security Factors</h2>
            <div class="factor-group">
              <label for="securityCriticalityFactor">Criticality Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="securityCriticalityFactorValue" min="0" max="10" value="0.5" step="0.01" style="width: 150px;">
                <input type="range" id="securityCriticalityFactor" min="0" max="10" value="0.5" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="securityTimingFactor">Timing Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="securityTimingFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 150px;">
                <input type="range" id="securityTimingFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="securityBusinessScaleFactor">Business Scale Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="securityBusinessScaleFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 150px;">
                <input type="range" id="securityBusinessScaleFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
            </div>
          </div>
          <div id="costOptimizationFactors" class="nested-tab-content">
            <h2>Cost Optimization Factors</h2>
            <div class="factor-group">
              <label for="costOptimizationTimingFactor">Timing Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="costOptimizationTimingFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 150px;">
                <input type="range" id="costOptimizationTimingFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="costOptimizationBusinessScaleFactor">Business Scale Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="costOptimizationBusinessScaleFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 150px;">
                <input type="range" id="costOptimizationBusinessScaleFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="costOptimizationBusinessScaleLimit">Cost Optimization Business Scale Limit ($):</label>
              <input type="number" id="costOptimizationBusinessScaleLimit" min="0" max="10000" value="2000" style="width: 150px;">
            </div>
          </div>
          <div id="performanceReliabilityFactors" class="nested-tab-content">
            <h2>Performance & Reliability Factors</h2>
            <div class="factor-group">
              <label for="performanceReliabilitySeverityFactor">Severity Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="performanceReliabilitySeverityFactorValue" min="0" max="10" value="0.5" step="0.01" style="width: 60px;">
                <input type="range" id="performanceReliabilitySeverityFactor" min="0" max="10" value="0.5" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="performanceReliabilityTimingFactor">Timing Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="performanceReliabilityTimingFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 60px;">
                <input type="range" id="performanceReliabilityTimingFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="performanceReliabilityBusinessScaleFactor">Business Scale Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="performanceReliabilityBusinessScaleFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 60px;">
                <input type="range" id="performanceReliabilityBusinessScaleFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
            </div>
          </div>
          <div id="dataEngineeringFactors" class="nested-tab-content">
            <h2>Data Engineering Factors</h2>
            <div class="factor-group">
              <label for="dataEngineeringSeverityFactor">Severity Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="dataEngineeringSeverityFactorValue" min="0" max="10" value="0.5" step="0.01" style="width: 60px;">
                <input type="range" id="dataEngineeringSeverityFactor" min="0" max="10" value="0.5" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="dataEngineeringTimingFactor">Timing Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="dataEngineeringTimingFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 60px;">
                <input type="range" id="dataEngineeringTimingFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
              <label for="dataEngineeringBusinessScaleFactor">Business Scale Factor:</label>
              <div style="display: flex; align-items: center;">
                <input type="number" id="dataEngineeringBusinessScaleFactorValue" min="0" max="10" value="0.25" step="0.01" style="width: 60px;">
                <input type="range" id="dataEngineeringBusinessScaleFactor" min="0" max="10" value="0.25" step="0.01" style="flex-grow: 1; margin-left: 10px;">
              </div>
            </div>
          </div>
          <button id="resetFactorsButton">Reset Factors to Default</button>
        </div>
        <div id="parameters" class="tab-content">
          <div class="nested-tabs">
            <div class="nested-tab active" data-tab="clientExperienceParameters">Client Experience</div>
            <div class="nested-tab" data-tab="productDeliveryParameters">Product Delivery</div>
            <div class="nested-tab" data-tab="securityParameters">Security</div>
            <div class="nested-tab" data-tab="costOptimizationParameters">Cost Optimization</div>
            <div class="nested-tab" data-tab="performanceReliabilityParameters">Performance & Reliability</div>
            <div class="nested-tab" data-tab="dataEngineeringParameters">Data Engineering</div>
          </div>
          <div id="clientExperienceParameters" class="nested-tab-content active">
            <div class="third-tabs">
              <div class="third-tab active" data-tab="showstopperParametersContainer">Showstopper</div>
              <div class="third-tab" data-tab="frequencyParametersContainer">Frequency</div>
              <div class="third-tab" data-tab="timeSpentParametersContainer">Time Spent</div>
            </div>
            <div id="showstopperParametersContainer" class="third-tab-content active">
              <h3>Showstopper Parameters:</h3>
              <div id="showstopperParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('showstopper')">Add</button>
            </div>
            <div id="frequencyParametersContainer" class="third-tab-content">
              <h3>Frequency Parameters:</h3>
              <div id="frequencyParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('frequency')">Add</button>
            </div>
            <div id="timeSpentParametersContainer" class="third-tab-content">
              <h3>Time Spent Parameters:</h3>
              <div id="timeSpentParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('timeSpent')">Add</button>
            </div>
          </div>
          <div id="productDeliveryParameters" class="nested-tab-content">
            <div class="third-tabs">
              <div class="third-tab active" data-tab="dealbreakerParametersContainer">Dealbreaker</div>
              <div class="third-tab" data-tab="projectTimeParametersContainer">Project Time</div>
            </div>
            <div id="dealbreakerParametersContainer" class="third-tab-content active">
              <h3>Dealbreaker Parameters:</h3>
              <div id="dealbreakerParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('dealbreaker')">Add</button>
            </div>
            <div id="projectTimeParametersContainer" class="third-tab-content">
              <h3>Project Time Parameters:</h3>
              <div id="projectTimeParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('projectTime')">Add</button>
            </div>
          </div>
          <div id="securityParameters" class="nested-tab-content">
            <div class="third-tabs">
              <div class="third-tab active" data-tab="companyShutdownParametersContainer">Company Shutdown</div>
              <div class="third-tab" data-tab="likelihoodParametersContainer">Likelihood</div>
            </div>
            <div id="companyShutdownParametersContainer" class="third-tab-content active">
              <h3>Company Shutdown Parameters:</h3>
              <div id="companyShutdownParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('companyShutdown')">Add</button>
            </div>
            <div id="likelihoodParametersContainer" class="third-tab-content">
              <h3>Likelihood Parameters:</h3>
              <div id="likelihoodParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('likelihood')">Add</button>
            </div>
          </div>
          <div id="costOptimizationParameters" class="nested-tab-content">
            <div class="third-tabs">
              <div class="third-tab" data-tab="implementationTimeParametersContainer">Implementation Time</div>
            </div>
            <div id="costReductionParametersContainer" class="third-tab-content active">
              <h3>Cost Reduction Parameters:</h3>
              <div id="costReductionParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('costReduction')">Add</button>
            </div>
            <div id="implementationTimeParametersContainer" class="third-tab-content">
              <h3>Implementation Time Parameters:</h3>
              <div id="implementationTimeParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('implementationTime')">Add</button>
            </div>
          </div>
          <div id="performanceReliabilityParameters" class="nested-tab-content">
            <div class="third-tabs">
              <div class="third-tab active" data-tab="severityParametersContainer">Severity</div>
              <div class="third-tab" data-tab="developmentTimeParametersContainer">Development Time</div>
            </div>
            <div id="severityParametersContainer" class="third-tab-content active">
              <h3>Severity Parameters:</h3>
              <div id="severityParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('severity')">Add</button>
            </div>
            <div id="developmentTimeParametersContainer" class="third-tab-content">
              <h3>Development Time Parameters:</h3>
              <div id="developmentTimeParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('developmentTime')">Add</button>
            </div>
          </div>
          <div id="dataEngineeringParameters" class="nested-tab-content">
            <div class="third-tabs">
              <div class="third-tab active" data-tab="dataEngineeringSeverityParametersContainer">Severity</div>
              <div class="third-tab" data-tab="dataEngineeringDevelopmentTimeParametersContainer">Development Time</div>
            </div>
            <div id="dataEngineeringSeverityParametersContainer" class="third-tab-content active">
              <h3>Severity Parameters:</h3>
              <div id="dataEngineeringSeverityParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('dataEngineeringSeverity')">Add</button>
            </div>
            <div id="dataEngineeringDevelopmentTimeParametersContainer" class="third-tab-content">
              <h3>Development Time Parameters:</h3>
              <div id="dataEngineeringDevelopmentTimeParameters"></div>
              <button class="add-parameter-button" onclick="addParameterPair('dataEngineeringDevelopmentTime')">Add</button>
            </div>
          </div>
          <!-- <button id="saveParametersButton">Save Parameters</button> -->
          <button id="resetParametersButton" class="reset-parameters-button">Reset Parameters to Default</button>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-analytics.js";
    // Import Firebase Authentication
    import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCPkl50_ACfN2waVMcukftwo8V_peWRXxU",
      authDomain: "comprehensive-triage-db.firebaseapp.com",
      databaseURL: "https://comprehensive-triage-db-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "comprehensive-triage-db",
      // storageBucket: "comprehensive-triage-db.firebasestorage.app",
      messagingSenderId: "587195188806",
      appId: "1:587195188806:web:a0406852081a74f5062c47",
      measurementId: "G-9PD3LMDWN5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Google Sign-In
    const googleSignInButton = document.getElementById('googleSignInButton');
    const mainContent = document.getElementById('mainContent');

    googleSignInButton.addEventListener('click', () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider)
        .then((result) => {
          console.log('User signed in:', result.user);
          googleSignInButton.innerText = `Signed in as ${result.user.displayName}`;
          addSignOutButton();
          // Save user email to Firestore
          const userEmail = result.user.email;
          const emailDomain = userEmail.split('@')[1];

          if (emailDomain !== 'promotexter.com') {
            console.error('Unauthorized email domain');
            auth.signOut().then(() => {
              console.log('User signed out');
              googleSignInButton.innerText = 'Sign in with Google';
              googleSignInButton.parentNode.querySelector('.logout-button')?.remove();
              mainContent.style.display = 'none';
            }).catch((error) => {
              console.error('Error during sign-out:', error);
            });
            alert('Unauthorized email domain. Please use a valid promotexter.com email.');
          } else {
            mainContent.style.display = 'block';
          }
          
        })
        .catch((error) => {
          console.error('Error during sign-in:', error);
          // Handle sign-in errors
        });
    });

    auth.onAuthStateChanged((user) => {
      if (auth.currentUser) {
        googleSignInButton.innerText = `Signed in as ${auth.currentUser.displayName}`;
        addSignOutButton();
        mainContent.style.display = 'block';
      } else {
        googleSignInButton.innerText = 'Sign in with Google';
        mainContent.style.display = 'none';
      }
    });

    function addSignOutButton() {
      const existingSignOutButton = document.querySelector('.btn.btn-secondary.logout-button');
      if (existingSignOutButton) {
        existingSignOutButton.remove();
      }
      const signOutButton = document.createElement('button');
      signOutButton.innerText = 'Sign out';
      signOutButton.className = 'btn btn-secondary logout-button';
      signOutButton.addEventListener('click', () => {
        auth.signOut().then(() => {
          console.log('User signed out');
          googleSignInButton.innerText = 'Sign in with Google';
          signOutButton.remove();
          mainContent.style.display = 'none';
        }).catch((error) => {
          console.error('Error during sign-out:', error);
        });
      });
      googleSignInButton.parentNode.appendChild(signOutButton);
    }

    // Function to save state to Firestore
    async function saveStateToFirestore() {
      if (!auth.currentUser) {
        console.log("User not logged in");
        return;
      }
      const currentState = getCurrentState();
      const docRef = doc(db, "state", "current");
      await setDoc(docRef, { state: currentState });
      console.log("State saved to Firestore");
      updateEntryScores();
    }

    // Function to load state from Firestore
    async function loadStateFromFirestore() {
      if (!auth.currentUser) {
        console.log("User not logged in");
        return;
      }
      const docRef = doc(db, "state", "current");
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const state = docSnap.data().state;
        localStorage.setItem('triageState', state); // Temporarily store in local storage for compatibility
        const parsedState = JSON.parse(state);
        categorySelect.value = parsedState.category;
        clientExperienceCriticalityFactor.value = parsedState.clientExperienceCriticalityFactor;
        clientExperienceTimingFactor.value = parsedState.clientExperienceTimingFactor;
        clientExperienceBusinessScaleFactor.value = parsedState.clientExperienceBusinessScaleFactor;
        productDeliveryCriticalityFactor.value = parsedState.productDeliveryCriticalityFactor;
        productDeliveryTimingFactor.value = parsedState.productDeliveryTimingFactor;
        productDeliveryBusinessScaleFactor.value = parsedState.productDeliveryBusinessScaleFactor;
        productDeliveryBusinessScaleLimit.value = parsedState.productDeliveryBusinessScaleLimit;
        securityCriticalityFactor.value = parsedState.securityCriticalityFactor;
        securityTimingFactor.value = parsedState.securityTimingFactor;
        securityBusinessScaleFactor.value = parsedState.securityBusinessScaleFactor;
        costOptimizationTimingFactor.value = parsedState.costOptimizationTimingFactor;
        costOptimizationBusinessScaleFactor.value = parsedState.costOptimizationBusinessScaleFactor;
        costOptimizationBusinessScaleLimit.value = parsedState.costOptimizationBusinessScaleLimit;
        performanceReliabilitySeverityFactor.value = parsedState.performanceReliabilitySeverityFactor;
        performanceReliabilityTimingFactor.value = parsedState.performanceReliabilityTimingFactor;
        performanceReliabilityBusinessScaleFactor.value = parsedState.performanceReliabilityBusinessScaleFactor;
        dataEngineeringSeverityFactor.value = parsedState.dataEngineeringSeverityFactor;
        dataEngineeringTimingFactor.value = parsedState.dataEngineeringTimingFactor;
        dataEngineeringBusinessScaleFactor.value = parsedState.dataEngineeringBusinessScaleFactor;
        parameters = parsedState.parameters;
        valueMappers = parsedState.valueMappers;
        populateDropdowns();
        populateParameterFields();
        updateFactorValues();
        displayPermutationTable();
        sortEntriesTable();
        calculateScore();
        console.log("State loaded from Firestore");
      } else {
        console.log("No state found in Firestore");
      }
    }

    async function loadState() {
      await loadStateFromFirestore();
      const namespaceParam = new URLSearchParams(window.location.search).get('namespace');
      const namespaces = namespaceParam ? namespaceParam.split(',').map(ns => ns.trim()) : ['default'];
      await loadEntriesFromFirestore(namespaces);
      listenForEntriesChanges(namespaces);
    }

    // Function to check state difference using Firestore
    async function checkStateDifference() {
      if (!auth.currentUser) {
        console.log("User not logged in");
        return;
      }
      const currentState = getCurrentState();
      const docRef = doc(db, "state", "current");
      const docSnap = await getDoc(docRef);
      const savedState = docSnap.exists() ? docSnap.data().state : null;

      const namespace = new URLSearchParams(window.location.search).get('namespace') || namespaceInput.value.trim() || 'default';
      const entriesCollection = collection(db, "entries", namespace, "data");
      const querySnapshot = await getDocs(entriesCollection);
      const savedEntries = querySnapshot.docs.map(doc => doc.data());

      const entriesDiffer = entries.some(entry => {
        const savedEntry = savedEntries.find(e => e.id === entry.id);
        return !savedEntry ||
               entry.criticality !== savedEntry.criticality ||
               entry.timing !== savedEntry.timing ||
               entry.businessScale !== savedEntry.businessScale ||
               entry.score !== savedEntry.score ||
               entry.priorityLevel !== savedEntry.priorityLevel ||
               entry.criticality != entry.updatedEntry.criticality ||
               entry.timing != entry.updatedEntry.timing ||
               entry.businessScale != entry.updatedEntry.businessScale ||
               entry.score != entry.updatedEntry.score ||
               entry.priorityLevel != entry.updatedEntry.priorityLevel;
      });

      saveStateButton.disabled = (currentState === savedState && !entriesDiffer);
      resetStateButton.disabled = (currentState === savedState);
    }

    // Function to listen for state changes in Firestore
    function listenForStateChanges() {
      const docRef = doc(db, "state", "current");
      onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          const state = docSnap.data().state;
          localStorage.setItem('triageState', state); // Temporarily store in local storage for compatibility
          const parsedState = JSON.parse(state);
          categorySelect.value = parsedState.category;
          clientExperienceCriticalityFactor.value = parsedState.clientExperienceCriticalityFactor;
          clientExperienceTimingFactor.value = parsedState.clientExperienceTimingFactor;
          clientExperienceBusinessScaleFactor.value = parsedState.clientExperienceBusinessScaleFactor;
          productDeliveryCriticalityFactor.value = parsedState.productDeliveryCriticalityFactor;
          productDeliveryTimingFactor.value = parsedState.productDeliveryTimingFactor;
          productDeliveryBusinessScaleFactor.value = parsedState.productDeliveryBusinessScaleFactor;
          productDeliveryBusinessScaleLimit.value = parsedState.productDeliveryBusinessScaleLimit;
          securityCriticalityFactor.value = parsedState.securityCriticalityFactor;
          securityTimingFactor.value = parsedState.securityTimingFactor;
          securityBusinessScaleFactor.value = parsedState.securityBusinessScaleFactor;
          costOptimizationTimingFactor.value = parsedState.costOptimizationTimingFactor;
          costOptimizationBusinessScaleFactor.value = parsedState.costOptimizationBusinessScaleFactor;
          costOptimizationBusinessScaleLimit.value = parsedState.costOptimizationBusinessScaleLimit;
          performanceReliabilitySeverityFactor.value = parsedState.performanceReliabilitySeverityFactor;
          performanceReliabilityTimingFactor.value = parsedState.performanceReliabilityTimingFactor;
          performanceReliabilityBusinessScaleFactor.value = parsedState.performanceReliabilityBusinessScaleFactor;
          dataEngineeringSeverityFactor.value = parsedState.dataEngineeringSeverityFactor;
          dataEngineeringTimingFactor.value = parsedState.dataEngineeringTimingFactor;
          dataEngineeringBusinessScaleFactor.value = parsedState.dataEngineeringBusinessScaleFactor;
          parameters = parsedState.parameters;
          valueMappers = parsedState.valueMappers;
          populateDropdowns();
          populateParameterFields();
          updateFactorValues();
          displayPermutationTable();
          sortEntriesTable();
          calculateScore();
          console.log("State updated from Firestore");
        }
      });
    }

    let unsubscribeEntriesListener = null;

    function listenForEntriesChanges(namespaces = ["default"]) {
      if (unsubscribeEntriesListener) {
        unsubscribeEntriesListener();
      }
      const entriesCollections = namespaces.map(namespace => collection(db, "entries", namespace, "data"));
      const queries = entriesCollections.map(entriesCollection => getDocs(entriesCollection));
      Promise.all(queries).then(querySnapshots => {
        entries = querySnapshots.flatMap(querySnapshot => querySnapshot.docs.map(doc => ({ ...doc.data(), namespace: doc.ref.parent.parent.id })));
        sortEntriesTable();
        console.log("Entries updated from Firestore");
      }).catch(error => {
        console.error("Error listening for entries changes:", error);
      });
    }

    // Function to listen for active users
    function listenForActiveUsers() {
      const activeUsersRef = collection(db, "activeUsers");
      onSnapshot(activeUsersRef, (snapshot) => {
        const activeUsers = snapshot.docs.map(doc => doc.data());
        displayActiveUsers(activeUsers);
      });
    }

    // Function to display active users
    function displayActiveUsers(users) {
      const activeUsersContainer = document.getElementById('activeUsers');
      activeUsersContainer.innerHTML = '';
      const now = new Date();
      users.forEach(user => {
        const lastActivity = new Date(user.lastActivity);
        const timeDiff = now - lastActivity;
        const oneHour = 60 * 60 * 1000;
        const oneDay = 24 * 60 * 60 * 1000;
        let badgeClass = '';

        if (timeDiff <= oneHour) {
          badgeClass = '';
        } else if (timeDiff <= oneDay) {
          badgeClass = 'inactive';
        } else {
          badgeClass = 'hidden';
        }

        const userBadge = document.createElement('div');
        userBadge.className = `user-badge ${badgeClass}`;
        userBadge.innerText = user.displayName.split(' ').map(name => name[0]).join('');
        const colors = [
          '#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#A133FF', '#33FFF5', '#FF8C33', '#8CFF33', '#338CFF', '#FF338C'
        ];

        function getColorForInitials(initials) {
          const charCodeSum = initials.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
          return colors[charCodeSum % colors.length];
        }

        userBadge.style.backgroundColor = getColorForInitials(user.displayName.split(' ').map(name => name[0]).join(''));
        if (badgeClass === 'inactive') {
          userBadge.style.opacity = '0.6';
        } else if (badgeClass === 'hidden') {
          userBadge.style.opacity = '0.3';
        }
        userBadge.title = user.email;
        activeUsersContainer.appendChild(userBadge);
      });
    }

    // Function to update user activity
    async function updateUserActivity() {
      if (auth.currentUser) {
        const userRef = doc(db, "activeUsers", auth.currentUser.uid);
        await setDoc(userRef, {
          displayName: auth.currentUser.displayName,
          email: auth.currentUser.email,
          lastActivity: new Date().toISOString()
        });
      }
    }

    // Add event listeners for user activity
    document.addEventListener('click', debounce(updateUserActivity, 1000));
    document.addEventListener('keydown', debounce(updateUserActivity, 1000));

    // Initial call to load state and entries from Firestore
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        await loadState();
        listenForStateChanges();
        const namespace = new URLSearchParams(window.location.search).get('namespace') || namespaceInput.value.trim() || 'default';
        const namespaces = namespace.split(',').map(ns => ns.trim());
        listenForEntriesChanges(namespaces);
        listenForActiveUsers();
        await updateUserActivity();
      } else {
        await deleteDoc(doc(db, "activeUsers", auth.currentUser.uid));
      }
    });

    const categorySelect = document.getElementById('categorySelect');
    const clientExperienceFields = document.getElementById('clientExperienceFields');
    const productDeliveryFields = document.getElementById('productDeliveryFields');
    const securityFields = document.getElementById('securityFields');
    const costOptimizationFields = document.getElementById('costOptimizationFields');
    const performanceReliabilityFields = document.getElementById('performanceReliabilityFields');
    const dataEngineeringFields = document.getElementById('dataEngineeringFields');
    const tableBody = document.getElementById('tableBody');
    const toggleViewButton = document.getElementById('toggleViewButton');
    const calculatorView = document.getElementById('calculatorView');
    const permutationTableView = document.getElementById('permutationTableView');
    const resetFiltersButton = document.getElementById('resetFiltersButton');
    const resetFactorsButton = document.getElementById('resetFactorsButton');
    const saveParametersButton = document.getElementById('saveParametersButton');
    const resetParametersButton = document.getElementById('resetParametersButton');
    const saveStateButton = document.getElementById('saveStateButton');
    const resetStateButton = document.getElementById('resetStateButton');

    const clientExperienceCriticalityFactor = document.getElementById('clientExperienceCriticalityFactor');
    const clientExperienceTimingFactor = document.getElementById('clientExperienceTimingFactor');
    const clientExperienceBusinessScaleFactor = document.getElementById('clientExperienceBusinessScaleFactor');
    const productDeliveryCriticalityFactor = document.getElementById('productDeliveryCriticalityFactor');
    const productDeliveryTimingFactor = document.getElementById('productDeliveryTimingFactor');
    const productDeliveryBusinessScaleFactor = document.getElementById('productDeliveryBusinessScaleFactor');
    const productDeliveryBusinessScaleLimit = document.getElementById('productDeliveryBusinessScaleLimit');
    const securityCriticalityFactor = document.getElementById('securityCriticalityFactor');
    const securityTimingFactor = document.getElementById('securityTimingFactor');
    const securityBusinessScaleFactor = document.getElementById('securityBusinessScaleFactor');
    const costOptimizationTimingFactor = document.getElementById('costOptimizationTimingFactor');
    const costOptimizationBusinessScaleFactor = document.getElementById('costOptimizationBusinessScaleFactor');
    const costOptimizationBusinessScaleLimit = document.getElementById('costOptimizationBusinessScaleLimit');
    const performanceReliabilitySeverityFactor = document.getElementById('performanceReliabilitySeverityFactor');
    const performanceReliabilityTimingFactor = document.getElementById('performanceReliabilityTimingFactor');
    const performanceReliabilityBusinessScaleFactor = document.getElementById('performanceReliabilityBusinessScaleFactor');
    const dataEngineeringSeverityFactor = document.getElementById('dataEngineeringSeverityFactor');
    const dataEngineeringTimingFactor = document.getElementById('dataEngineeringTimingFactor');
    const dataEngineeringBusinessScaleFactor = document.getElementById('dataEngineeringBusinessScaleFactor');

    const clientExperienceCriticalityFactorValue = document.getElementById('clientExperienceCriticalityFactorValue');
    const clientExperienceTimingFactorValue = document.getElementById('clientExperienceTimingFactorValue');
    const clientExperienceBusinessScaleFactorValue = document.getElementById('clientExperienceBusinessScaleFactorValue');
    const productDeliveryCriticalityFactorValue = document.getElementById('productDeliveryCriticalityFactorValue');
    const productDeliveryTimingFactorValue = document.getElementById('productDeliveryTimingFactorValue');
    const productDeliveryBusinessScaleFactorValue = document.getElementById('productDeliveryBusinessScaleFactorValue');
    const securityCriticalityFactorValue = document.getElementById('securityCriticalityFactorValue');
    const securityTimingFactorValue = document.getElementById('securityTimingFactorValue');
    const securityBusinessScaleFactorValue = document.getElementById('securityBusinessScaleFactorValue');
    const costOptimizationTimingFactorValue = document.getElementById('costOptimizationTimingFactorValue');
    const costOptimizationBusinessScaleFactorValue = document.getElementById('costOptimizationBusinessScaleFactorValue');
    const performanceReliabilitySeverityFactorValue = document.getElementById('performanceReliabilitySeverityFactorValue');
    const performanceReliabilityTimingFactorValue = document.getElementById('performanceReliabilityTimingFactorValue');
    const performanceReliabilityBusinessScaleFactorValue = document.getElementById('performanceReliabilityBusinessScaleFactorValue');
    const dataEngineeringSeverityFactorValue = document.getElementById('dataEngineeringSeverityFactorValue');
    const dataEngineeringTimingFactorValue = document.getElementById('dataEngineeringTimingFactorValue');
    const dataEngineeringBusinessScaleFactorValue = document.getElementById('dataEngineeringBusinessScaleFactorValue');

    const showstopperParameters = document.getElementById('showstopperParameters');
    const frequencyParameters = document.getElementById('frequencyParameters');
    const timeSpentParameters = document.getElementById('timeSpentParameters');
    const dealbreakerParameters = document.getElementById('dealbreakerParameters');
    const projectTimeParameters = document.getElementById('projectTimeParameters');
    const companyShutdownParameters = document.getElementById('companyShutdownParameters');
    const likelihoodParameters = document.getElementById('likelihoodParameters');
    const costReductionParameters = document.getElementById('costReductionParameters');
    const implementationTimeParameters = document.getElementById('implementationTimeParameters');
    const severityParameters = document.getElementById('severityParameters');
    const developmentTimeParameters = document.getElementById('developmentTimeParameters');
    const dataEngineeringSeverityParameters = document.getElementById('dataEngineeringSeverityParameters');
    const dataEngineeringDevelopmentTimeParameters = document.getElementById('dataEngineeringDevelopmentTimeParameters');

    const toggleDarkModeButton = document.getElementById('toggleDarkModeButton');

    const saveEntryButton = document.getElementById('saveEntryButton');
    const cancelUpdateButton = document.getElementById('cancelUpdateButton');
    const entriesTableBody = document.getElementById('entriesTable').querySelector('tbody');
    const copyTableButton = document.getElementById('copyTableButton');

    const filterInput = document.getElementById('filterInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const criticalityFilter = document.getElementById('criticalityFilter');
    const timingFilter = document.getElementById('timingFilter');
    const businessScaleFilter = document.getElementById('businessScaleFilter');
    const toggleFiltersButton = document.getElementById('toggleFiltersButton');
    const filtersRow = document.getElementById('filtersRow');
    const clearCategoryFilter = document.getElementById('clearCategoryFilter');
    const clearCriticalityFilter = document.getElementById('clearCriticalityFilter');
    const clearTimingFilter = document.getElementById('clearTimingFilter');
    const clearBusinessScaleFilter = document.getElementById('clearBusinessScaleFilter');
    const clearAllFiltersButton = document.getElementById('clearAllFiltersButton');
    const namespaceInput = document.getElementById('namespaceInput');
    const loadNamespaceButton = document.getElementById('loadNamespaceButton');
    const statusFilter = document.getElementById('statusFilter');

    let editingRow = null;

    toggleDarkModeButton.addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      saveDarkModeState();
    });

    function saveDarkModeState() {
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
    }

    function loadDarkModeState() {
      const isDarkMode = JSON.parse(localStorage.getItem('darkMode'));
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
      }
    }

    // Initial call to load dark mode state
    loadDarkModeState();

    let parameters = {
      showstopper: ['No Impact', 'Not Critical', 'Low Criticality', 'Moderate Criticality', 'High Criticality', 'Total Stop'],
      frequency: ['Once in 5 Years', 'Once a Year or Less', 'Every 6 Months', 'Monthly', 'Weekly', 'Daily'],
      timeSpent: ['No Time Spent', 'Less than 1 hour', 'Less than 2 hours', 'Half a day', 'Full day', 'Overtime'],
      dealbreaker: ['No Impact', 'Not Critical', 'Low Priority', 'Medium Priority', 'High Priority', 'Must Have'],
      projectTime: ['No Time', '1 Year', '6 Months', '1 Month', '1 Week', '1 Day'],
      companyShutdown: ['No Impact', 'No Impact', 'Low Impact', 'Moderate Impact', 'High Impact', 'Total Shutdown'],
      likelihood: ['Never', 'Very Unlikely', 'Unlikely', 'Possible', 'Likely', 'Very Likely'],
      // costReduction: ['No Reduction', 'Minimal Reduction', 'Low Reduction', 'Moderate Reduction', 'High Reduction', 'Maximum Reduction'],
      implementationTime: ['Immediate', '1 Week', '1 Month', '3 Months', '6 Months', '1 Year'],
      severity: ['No Degradation', 'Minimal Degradation', 'Low Degradation', 'Moderate Degradation', 'High Degradation', 'Total Downtime'],
      developmentTime: ['Immediate', '1 Week', '1 Month', '3 Months', '6 Months', '1 Year'],
      dataEngineeringSeverity: ['Slow Query', 'Incorrect Calculation', 'Data Loss', 'Data Corruption', 'System Crash', 'Total Data Loss'],
      dataEngineeringDevelopmentTime: ['Immediate', '1 Week', '1 Month', '3 Months', '6 Months', '1 Year']
    };

    let valueMappers = {
      showstopper: [0, 1, 2, 3, 4, 5],
      frequency: [0, 1, 2, 3, 4, 5],
      timeSpent: [0, 1, 2, 3, 4, 5],
      dealbreaker: [0, 1, 2, 3, 4, 5],
      projectTime: [0, 1, 2, 3, 4, 5],
      companyShutdown: [0, 1, 2, 3, 4, 5],
      likelihood: [0, 1, 2, 3, 4, 5],
      costReduction: [0, 1, 2, 3, 4, 5],
      implementationTime: [0, 1, 2, 3, 4, 5],
      severity: [0, 1, 2, 3, 4, 5],
      developmentTime: [0, 1, 2, 3, 4, 5],
      dataEngineeringSeverity: [0, 1, 2, 3, 4, 5],
      dataEngineeringDevelopmentTime: [0, 1, 2, 3, 4, 5]
    };

    let filteredValues = {
      "Client Experience": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Product Delivery": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Security": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Cost Optimization": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Performance & Reliability": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Data Engineering": {
        criticality: [],
        timing: [],
        businessScale: []
      }
    };
    let entries = [];

    function updateFactorValues() {
      clientExperienceCriticalityFactorValue.value = clientExperienceCriticalityFactor.value;
      clientExperienceTimingFactorValue.value = clientExperienceTimingFactor.value;
      clientExperienceBusinessScaleFactorValue.value = clientExperienceBusinessScaleFactor.value;
      productDeliveryCriticalityFactorValue.value = productDeliveryCriticalityFactor.value;
      productDeliveryTimingFactorValue.value = productDeliveryTimingFactor.value;
      productDeliveryBusinessScaleFactorValue.value = productDeliveryBusinessScaleFactor.value;
      securityCriticalityFactorValue.value = securityCriticalityFactor.value;
      securityTimingFactorValue.value = securityTimingFactor.value;
      securityBusinessScaleFactorValue.value = securityBusinessScaleFactor.value;
      costOptimizationTimingFactorValue.value = costOptimizationTimingFactor.value;
      costOptimizationBusinessScaleFactorValue.value = costOptimizationBusinessScaleFactor.value;
      performanceReliabilitySeverityFactorValue.value = performanceReliabilitySeverityFactor.value;
      performanceReliabilityTimingFactorValue.value = performanceReliabilityTimingFactor.value;
      performanceReliabilityBusinessScaleFactorValue.value = performanceReliabilityBusinessScaleFactor.value;
      dataEngineeringSeverityFactorValue.value = dataEngineeringSeverityFactor.value;
      dataEngineeringTimingFactorValue.value = dataEngineeringTimingFactor.value;
      dataEngineeringBusinessScaleFactorValue.value = dataEngineeringBusinessScaleFactor.value;
      checkStateDifference();
    }

    function syncFactorValues() {
      clientExperienceCriticalityFactor.value = clientExperienceCriticalityFactorValue.value;
      clientExperienceTimingFactor.value = clientExperienceTimingFactorValue.value;
      clientExperienceBusinessScaleFactor.value = clientExperienceBusinessScaleFactorValue.value;
      productDeliveryCriticalityFactor.value = productDeliveryCriticalityFactorValue.value;
      productDeliveryTimingFactor.value = productDeliveryTimingFactorValue.value;
      productDeliveryBusinessScaleFactor.value = productDeliveryBusinessScaleFactorValue.value;
      securityCriticalityFactor.value = securityCriticalityFactorValue.value;
      securityTimingFactor.value = securityTimingFactorValue.value;
      securityBusinessScaleFactor.value = securityBusinessScaleFactorValue.value;
      costOptimizationTimingFactor.value = costOptimizationTimingFactorValue.value;
      costOptimizationBusinessScaleFactor.value = costOptimizationBusinessScaleFactorValue.value;
      performanceReliabilitySeverityFactor.value = performanceReliabilitySeverityFactorValue.value;
      performanceReliabilityTimingFactor.value = performanceReliabilityTimingFactorValue.value;
      performanceReliabilityBusinessScaleFactor.value = performanceReliabilityBusinessScaleFactorValue.value;
      dataEngineeringSeverityFactor.value = dataEngineeringSeverityFactorValue.value;
      dataEngineeringTimingFactor.value = dataEngineeringTimingFactorValue.value;
      dataEngineeringBusinessScaleFactor.value = dataEngineeringBusinessScaleFactorValue.value;
      checkStateDifference();
    }

    function populateDropdowns() {
      const showstopperSelect = document.getElementById('showstopper');
      const frequencySelect = document.getElementById('frequency');
      const timeSpentSelect = document.getElementById('timeSpent');
      const dealbreakerSelect = document.getElementById('dealbreaker');
      const projectTimeSelect = document.getElementById('projectTime');
      const companyShutdownSelect = document.getElementById('companyShutdown');
      const likelihoodSelect = document.getElementById('likelihood');
      const implementationTimeSelect = document.getElementById('implementationTime');
      const severitySelect = document.getElementById('severity');
      const developmentTimeSelect = document.getElementById('developmentTime');
      const dataEngineeringSeveritySelect = document.getElementById('dataEngineeringSeverity');
      const dataEngineeringDevelopmentTimeSelect = document.getElementById('dataEngineeringDevelopmentTime');

      showstopperSelect.innerHTML = '';
      frequencySelect.innerHTML = '';
      timeSpentSelect.innerHTML = '';
      dealbreakerSelect.innerHTML = '';
      projectTimeSelect.innerHTML = '';
      companyShutdownSelect.innerHTML = '';
      likelihoodSelect.innerHTML = '';
      implementationTimeSelect.innerHTML = '';
      severitySelect.innerHTML = '';
      developmentTimeSelect.innerHTML = '';
      dataEngineeringSeveritySelect.innerHTML = '';
      dataEngineeringDevelopmentTimeSelect.innerHTML = '';

      parameters.showstopper.forEach((desc, index) => {
        showstopperSelect.options.add(new Option(`${valueMappers.showstopper[index]} - ${desc}`, valueMappers.showstopper[index]));
      });

      parameters.frequency.forEach((desc, index) => {
        frequencySelect.options.add(new Option(`${valueMappers.frequency[index]} - ${desc}`, valueMappers.frequency[index]));
      });

      parameters.timeSpent.forEach((desc, index) => {
        timeSpentSelect.options.add(new Option(`${valueMappers.timeSpent[index]} - ${desc}`, valueMappers.timeSpent[index]));
      });

      parameters.dealbreaker.forEach((desc, index) => {
        dealbreakerSelect.options.add(new Option(`${valueMappers.dealbreaker[index]} - ${desc}`, valueMappers.dealbreaker[index]));
      });

      parameters.projectTime.forEach((desc, index) => {
        projectTimeSelect.options.add(new Option(`${valueMappers.projectTime[index]} - ${desc}`, valueMappers.projectTime[index]));
      });

      parameters.companyShutdown.forEach((desc, index) => {
        companyShutdownSelect.options.add(new Option(`${valueMappers.companyShutdown[index]} - ${desc}`, valueMappers.companyShutdown[index]));
      });

      parameters.likelihood.forEach((desc, index) => {
        likelihoodSelect.options.add(new Option(`${valueMappers.likelihood[index]} - ${desc}`, valueMappers.likelihood[index]));
      });

      parameters.implementationTime.forEach((desc, index) => {
        implementationTimeSelect.options.add(new Option(`${valueMappers.implementationTime[index]} - ${desc}`, valueMappers.implementationTime[index]));
      });

      parameters.severity.forEach((desc, index) => {
        severitySelect.options.add(new Option(`${valueMappers.severity[index]} - ${desc}`, valueMappers.severity[index]));
      });

      parameters.developmentTime.forEach((desc, index) => {
        developmentTimeSelect.options.add(new Option(`${valueMappers.developmentTime[index]} - ${desc}`, valueMappers.developmentTime[index]));
      });

      parameters.dataEngineeringSeverity.forEach((desc, index) => {
        dataEngineeringSeveritySelect.options.add(new Option(`${valueMappers.dataEngineeringSeverity[index]} - ${desc}`, valueMappers.dataEngineeringSeverity[index]));
      });

      parameters.dataEngineeringDevelopmentTime.forEach((desc, index) => {
        dataEngineeringDevelopmentTimeSelect.options.add(new Option(`${valueMappers.dataEngineeringDevelopmentTime[index]} - ${desc}`, valueMappers.dataEngineeringDevelopmentTime[index]));
      });
    }

    categorySelect.addEventListener('change', function() {
      const selectedCategory = categorySelect.value;
      clientExperienceFields.style.display = (selectedCategory === 'clientExperience') ? 'block' : 'none';
      productDeliveryFields.style.display = (selectedCategory === 'productDelivery') ? 'block' : 'none';
      securityFields.style.display = (selectedCategory === 'security') ? 'block' : 'none';
      costOptimizationFields.style.display = (selectedCategory === 'costOptimization') ? 'block' : 'none';
      performanceReliabilityFields.style.display = (selectedCategory === 'performanceReliability') ? 'block' : 'none';
      dataEngineeringFields.style.display = (selectedCategory === 'dataEngineering') ? 'block' : 'none';
      displayPermutationTable(); // Recalculate and display table when category changes
    });

    const inputs = document.querySelectorAll('select, input');
    inputs.forEach(input => {
      input.addEventListener('change', displayPermutationTable); // Recalculate and display table when input changes
    });

    toggleViewButton.addEventListener('click', function() {
      const isCalculatorVisible = calculatorView.style.display !== 'none';
      calculatorView.style.display = isCalculatorVisible ? 'none' : 'block';
      permutationTableView.style.display = isCalculatorVisible ? 'block' : 'none';
      toggleViewButton.innerText = isCalculatorVisible ? 'Show Calculator' : 'Show Permutation Table';
      updateURL(isCalculatorVisible ? 'permutations' : 'calculator');
    });

    function updateURL(view, tab, nestedTab, thirdTab, namespace, filters) {
      const url = new URL(window.location);
      if (view) {
        url.searchParams.set('view', view);
      }
      if (tab) {
        url.searchParams.set('tab', tab);
      }
      if (nestedTab) {
        url.searchParams.set('nestedTab', nestedTab);
      }
      if (thirdTab) {
        url.searchParams.set('thirdTab', thirdTab);
      }
      if (namespace) {
        url.searchParams.set('namespace', namespace);
      }
      if (filters) {
        Object.keys(filters).forEach(key => {
          url.searchParams.set(key, filters[key]);
        });
      }
      window.history.pushState({}, '', url);
    }

    function loadViewFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const view = urlParams.get('view');
      const tab = urlParams.get('tab');
      const nestedTab = urlParams.get('nestedTab');
      const thirdTab = urlParams.get('thirdTab');
      const namespace = urlParams.get('namespace') || 'default';
      const filters = {
        filter: urlParams.get('filter') || '',
        category: urlParams.get('category') || '',
        criticality: urlParams.get('criticality') || '',
        timing: urlParams.get('timing') || '',
        businessScale: urlParams.get('businessScale') || '',
        status: urlParams.get('status') ? urlParams.get('status').split(',') : []
      };

      if (view === 'permutations') {
        calculatorView.style.display = 'none';
        permutationTableView.style.display = 'block';
        toggleViewButton.innerText = 'Show Calculator';
      } else {
        calculatorView.style.display = 'block';
        permutationTableView.style.display = 'none';
        toggleViewButton.innerText = 'Show Permutation Table';
      }

      if (tab) {
        document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelector(`.tabs .tab[data-tab="${tab}"]`).classList.add('active');
        document.getElementById(tab).classList.add('active');
      }

      if (nestedTab) {
        document.querySelectorAll('.nested-tabs .nested-tab').forEach(nt => nt.classList.remove('active'));
        document.querySelectorAll('.nested-tab-content').forEach(ntc => ntc.classList.remove('active'));
        document.querySelector(`.nested-tabs .nested-tab[data-tab="${nestedTab}"]`).classList.add('active');
        document.getElementById(nestedTab).classList.add('active');
      }

      if (thirdTab) {
        document.querySelectorAll('.third-tabs .third-tab').forEach(tt => tt.classList.remove('active'));
        document.querySelectorAll('.third-tab-content').forEach(ttc => ttc.classList.remove('active'));
        document.querySelector(`.third-tabs .third-tab[data-tab="${thirdTab}"]`).classList.add('active');
        document.getElementById(thirdTab).classList.add('active');
      }

      if (namespace) {
        namespaceInput.value = namespace;
        loadEntriesFromFirestore(namespace).then(() => {
          // Apply filters after loading entries
          filterInput.value = filters.filter;
          categoryFilter.value = filters.category;
          criticalityFilter.value = filters.criticality;
          timingFilter.value = filters.timing;
          businessScaleFilter.value = filters.businessScale;
          statusFilter.value = filters.status;
          filterEntries();
        });
      } else {
        // Apply filters from URL
        filterInput.value = filters.filter;
        categoryFilter.value = filters.category;
        criticalityFilter.value = filters.criticality;
        timingFilter.value = filters.timing;
        businessScaleFilter.value = filters.businessScale;
        statusFilter.value = filters.status;
        filterEntries();
      }
    }

    // Initial call to load view from URL
    loadViewFromURL();

    resetFiltersButton.addEventListener('click', function() {
      filteredValues = {
      "Client Experience": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Product Delivery": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Security": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Cost Optimization": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Performance & Reliability": {
        criticality: [],
        timing: [],
        businessScale: []
      },
      "Data Engineering": {
        criticality: [],
        timing: [],
        businessScale: []
      }
    };
      displayPermutationTable();
    });

    resetFactorsButton.addEventListener('click', function() {
      if (confirm('Are you sure you want to reset factors to default?')) {
        clientExperienceCriticalityFactor.value = 0.5;
        clientExperienceTimingFactor.value = 0.25;
        clientExperienceBusinessScaleFactor.value = 0.25;
        productDeliveryCriticalityFactor.value = 0.5;
        productDeliveryTimingFactor.value = 0.25;
        productDeliveryBusinessScaleFactor.value = 1.25;
        productDeliveryBusinessScaleLimit.value = 20;
        securityCriticalityFactor.value = 0.5;
        securityTimingFactor.value = 0.25;
        securityBusinessScaleFactor.value = 0.25;
        costOptimizationTimingFactor.value = 0.5;
        costOptimizationBusinessScaleFactor.value = 0.5;
        costOptimizationBusinessScaleLimit.value = 2000;
        performanceReliabilitySeverityFactor.value = 0.5;
        performanceReliabilityTimingFactor.value = 0.25;
        performanceReliabilityBusinessScaleFactor.value = 0.25;
        dataEngineeringSeverityFactor.value = 0.5;
        dataEngineeringTimingFactor.value = 0.25;
        dataEngineeringBusinessScaleFactor.value = 0.25;
        updateFactorValues();
        displayPermutationTable();
        sortEntriesTable();
        calculateScore();
      }
    });

    const permutations = [];

    let lowPriorityChart, mediumPriorityChart, highPriorityChart;

    function displayPermutationTable() {
      permutations.length = 0;
      // Generate permutations for each category
      generateClientExperiencePermutations(permutations);
      generateProductDeliveryPermutations(permutations);
      generateSecurityPermutations(permutations);
      generateCostOptimizationPermutations(permutations);
      generatePerformanceReliabilityPermutations(permutations);
      generateDataEngineeringPermutations(permutations);

      // Sort permutations by score in descending order
      permutations.sort((a, b) => b.score - a.score);

      // Scale scores to be between 1 and 5
      const maxScore = permutations.length > 0 ? permutations[0].score : 1;
      const scaleFactor = maxScore > 5 ? 5 / maxScore : 1;

      // Clear the table
      tableBody.innerHTML = '';

      // Initialize priority counts
      const priorityCounts = {
        low: { "Client Experience": 0, "Product Delivery": 0, "Security": 0, "Cost Optimization": 0, "Performance & Reliability": 0, "Data Engineering": 0 },
        medium: { "Client Experience": 0, "Product Delivery": 0, "Security": 0, "Cost Optimization": 0, "Performance & Reliability": 0, "Data Engineering": 0 },
        high: { "Client Experience": 0, "Product Delivery": 0, "Security": 0, "Cost Optimization": 0, "Performance & Reliability": 0, "Data Engineering": 0 }
      };

      // Initialize total counts for each category
      const totalCounts = {
        "Client Experience": 0,
        "Product Delivery": 0,
        "Security": 0,
        "Cost Optimization": 0,
        "Performance & Reliability": 0,
        "Data Engineering": 0
      };

      // Append rows
      permutations.forEach(p => {
        if (!filteredValues[p.category].criticality.includes(p.criticalityValue) &&
            !filteredValues[p.category].timing.includes(p.timingValue) &&
            !filteredValues[p.category].businessScale.includes(p.businessScaleValue)) {
          const scaledScore = p.score * scaleFactor;
          const priorityLevel = calculatePriorityLevel(scaledScore);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="${p.category.charAt(0).toLowerCase() + p.category.slice(1).replace(/[\s&]+/g, '')}">${p.category}</td>
            <td>
              <button class="table-button" onclick="filterValue('${p.category}', 'criticality', ${p.criticalityValue})">x</button><span class="pill criticality-${p.criticalityValue}" style="display: inline-block; margin-left: 5px;">${p.criticality}</span>
            </td>
            <td>
              <button class="table-button" onclick="filterValue('${p.category}', 'timing', ${p.timingValue})">x</button><span class="pill timing-${p.timingValue}" style="display: inline-block; margin-left: 5px;">${p.timing}</span>
            </td>
            <td>
                <button class="table-button" onclick="filterValue('${p.category}', 'businessScale', ${p.businessScaleValue})">x</button><span class="pill businessScale-${p.businessScaleValue}" style="display: inline-block; margin-left: 5px;">${p.category === 'Cost Optimization' ? '$' + p.businessScale.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : p.businessScale + '%'}</span>
            </td>
            <td>${scaledScore.toFixed(2)}</td>
            <td>${priorityLevel}</td>
          `;
          tableBody.appendChild(row);

          // Update priority counts
          if (priorityLevel.includes('High')) {
            priorityCounts.high[p.category]++;
          } else if (priorityLevel.includes('Medium')) {
            priorityCounts.medium[p.category]++;
          } else {
            priorityCounts.low[p.category]++;
          }

          // Update total counts
          totalCounts[p.category]++;
        }
      });

      // Update the charts
      updatePriorityDistributionCharts(priorityCounts, totalCounts);

      // Update the permutation count
      document.getElementById('permutationCount').innerText = `Total Permutations: ${permutations.length}`;
    }

    function updatePriorityDistributionCharts(priorityCounts, totalCounts) {
      const lowPriorityData = {
        labels: ['Client Experience', 'Product Delivery', 'Security', 'Cost Optimization', 'Performance & Reliability', 'Data Engineering'],
        datasets: [{
          data: [
            (priorityCounts.low['Client Experience'] / totalCounts['Client Experience']) * 100,
            (priorityCounts.low['Product Delivery'] / totalCounts['Product Delivery']) * 100,
            (priorityCounts.low['Security'] / totalCounts['Security']) * 100,
            (priorityCounts.low['Cost Optimization'] / totalCounts['Cost Optimization']) * 100,
            (priorityCounts.low['Performance & Reliability'] / totalCounts['Performance & Reliability']) * 100,
            (priorityCounts.low['Data Engineering'] / totalCounts['Data Engineering']) * 100
          ],
          backgroundColor: ['#6d9eeb', '#8e7cc3', '#e06666', '#cc4125', '#93c47d', '#f6b26b'],
          borderColor: ['#6d9eeb', '#8e7cc3', '#e06666', '#cc4125', '#93c47d', '#f6b26b'],
          borderWidth: 1
        }]
      };

      const mediumPriorityData = {
        labels: ['Client Experience', 'Product Delivery', 'Security', 'Cost Optimization', 'Performance & Reliability', 'Data Engineering'],
        datasets: [{
          data: [
            (priorityCounts.medium['Client Experience'] / totalCounts['Client Experience']) * 100,
            (priorityCounts.medium['Product Delivery'] / totalCounts['Product Delivery']) * 100,
            (priorityCounts.medium['Security'] / totalCounts['Security']) * 100,
            (priorityCounts.medium['Cost Optimization'] / totalCounts['Cost Optimization']) * 100,
            (priorityCounts.medium['Performance & Reliability'] / totalCounts['Performance & Reliability']) * 100,
            (priorityCounts.medium['Data Engineering'] / totalCounts['Data Engineering']) * 100
          ],
          backgroundColor: ['#6d9eeb', '#8e7cc3', '#e06666', '#cc4125', '#93c47d', '#f6b26b'],
          borderColor: ['#6d9eeb', '#8e7cc3', '#e06666', '#cc4125', '#93c47d', '#f6b26b'],
          borderWidth: 1
        }]
      };

      const highPriorityData = {
        labels: ['Client Experience', 'Product Delivery', 'Security', 'Cost Optimization', 'Performance & Reliability', 'Data Engineering'],
        datasets: [{
          data: [
            (priorityCounts.high['Client Experience'] / totalCounts['Client Experience']) * 100,
            (priorityCounts.high['Product Delivery'] / totalCounts['Product Delivery']) * 100,
            (priorityCounts.high['Security'] / totalCounts['Security']) * 100,
            (priorityCounts.high['Cost Optimization'] / totalCounts['Cost Optimization']) * 100,
            (priorityCounts.high['Performance & Reliability'] / totalCounts['Performance & Reliability']) * 100,
            (priorityCounts.high['Data Engineering'] / totalCounts['Data Engineering']) * 100
          ],
          backgroundColor: ['#6d9eeb', '#8e7cc3', '#e06666', '#cc4125', '#93c47d', '#f6b26b'],
          borderColor: ['#6d9eeb', '#8e7cc3', '#e06666', '#cc4125', '#93c47d', '#f6b26b'],
          borderWidth: 1
        }]
      };

      const options = {
        responsive: true,
        plugins: {
          legend: false,
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                return `${label}`;
              }
            }
          }
        }
      };

      if (lowPriorityChart) {
        lowPriorityChart.data = lowPriorityData;
        lowPriorityChart.update();
      } else {
        lowPriorityChart = new Chart(document.getElementById('lowPriorityChart').getContext('2d'), {
          type: 'pie',
          data: lowPriorityData,
          options: options
        });
      }

      if (mediumPriorityChart) {
        mediumPriorityChart.data = mediumPriorityData;
        mediumPriorityChart.update();
      } else {
        mediumPriorityChart = new Chart(document.getElementById('mediumPriorityChart').getContext('2d'), {
          type: 'pie',
          data: mediumPriorityData,
          options: options
        });
      }

      if (highPriorityChart) {
        highPriorityChart.data = highPriorityData;
        highPriorityChart.update();
      } else {
        highPriorityChart = new Chart(document.getElementById('highPriorityChart').getContext('2d'), {
          type: 'pie',
          data: highPriorityData,
          options: options
        });
      }
    }

    function filterValue(category, type, value) {
      filteredValues[category][type].push(value);
      displayPermutationTable();
    }

    function generateClientExperiencePermutations(permutations) {
    const minShowstopper = Math.min(...valueMappers.showstopper);
    const maxShowstopper = Math.max(...valueMappers.showstopper);
    const minFrequency = Math.min(...valueMappers.frequency);
    const maxFrequency = Math.max(...valueMappers.frequency);
    const minTimeSpent = Math.min(...valueMappers.timeSpent);
    const maxTimeSpent = Math.max(...valueMappers.timeSpent);
    const businessScaleValues = [0, 20, 40, 60, 80, 100];

    for (let showstopper = 0; showstopper <= 5; showstopper++) {
      for (let frequency = 0; frequency <= 5; frequency++) {
        for (let timeSpent = 0; timeSpent <= 5; timeSpent++) {
          for (const businessScale of businessScaleValues) {
            const criticalityValue = Math.round(((valueMappers.showstopper[showstopper] - minShowstopper) / (maxShowstopper - minShowstopper)) * 5);
            const timingValue = Math.round((((valueMappers.frequency[frequency] - minFrequency) / (maxFrequency - minFrequency)) + ((valueMappers.timeSpent[timeSpent] - minTimeSpent) / (maxTimeSpent - minTimeSpent))) / 2 * 5);
            const score = (valueMappers.showstopper[showstopper] * parseFloat(clientExperienceCriticalityFactor.value)) + 
                          (valueMappers.frequency[frequency] / 2 * parseFloat(clientExperienceTimingFactor.value)) + 
                          (valueMappers.timeSpent[timeSpent] / 2 * parseFloat(clientExperienceTimingFactor.value)) + 
                          (businessScale / 20 * parseFloat(clientExperienceBusinessScaleFactor.value));
            permutations.push({
              category: 'Client Experience',
              criticality: `${parameters.showstopper[showstopper]}`,
              timing: `${parameters.frequency[frequency]} | ${parameters.timeSpent[timeSpent]}`,
              criticalityValue: criticalityValue,
              timingValue: timingValue,
              businessScale: businessScale,
              businessScaleValue: Math.ceil(businessScale / 20),
              score: score
            });
          }
        }
      }
    }
    }
    function generateProductDeliveryPermutations(permutations) {
      const productDeliveryBusinessScaleLimitValue = parseInt(productDeliveryBusinessScaleLimit.value);
      const businessScaleValues = [];
      for (let i = 0; i <= 5; i++) {
        businessScaleValues.push((productDeliveryBusinessScaleLimitValue / 5) * i);
      }

      const minDealbreaker = Math.min(...valueMappers.dealbreaker);
      const maxDealbreaker = Math.max(...valueMappers.dealbreaker);
      const minProjectTime = Math.min(...valueMappers.projectTime);
      const maxProjectTime = Math.max(...valueMappers.projectTime);

      for (let dealbreaker = 0; dealbreaker <= 5; dealbreaker++) {
        for (let projectTime = 0; projectTime <= 5; projectTime++) {
          for (const businessScale of businessScaleValues) {
            if (businessScale <= productDeliveryBusinessScaleLimitValue) {
              const criticalityValue = Math.round(((valueMappers.dealbreaker[dealbreaker] - minDealbreaker) / (maxDealbreaker - minDealbreaker)) * 5);
              const timingValue = Math.round(((valueMappers.projectTime[projectTime] - minProjectTime) / (maxProjectTime - minProjectTime)) * 5);
              const score = (valueMappers.dealbreaker[dealbreaker] * parseFloat(productDeliveryCriticalityFactor.value)) + 
                            (valueMappers.projectTime[projectTime] * parseFloat(productDeliveryTimingFactor.value)) + 
                            (businessScale / 20 * parseFloat(productDeliveryBusinessScaleFactor.value));
              permutations.push({
                category: 'Product Delivery',
                criticality: `${parameters.dealbreaker[dealbreaker]}`,
                timing: `${parameters.projectTime[projectTime]}`,
                criticalityValue: criticalityValue,
                timingValue: timingValue,
                businessScale: businessScale,
                businessScaleValue: Math.ceil((businessScale / productDeliveryBusinessScaleLimitValue) * 5),
                score: score
              });
            }
          }
        }
      }
    }

    function generateSecurityPermutations(permutations) {
      const businessScaleValues = [0, 20, 40, 60, 80, 100];

      const minCompanyShutdown = Math.min(...valueMappers.companyShutdown);
      const maxCompanyShutdown = Math.max(...valueMappers.companyShutdown);
      const minLikelihood = Math.min(...valueMappers.likelihood);
      const maxLikelihood = Math.max(...valueMappers.likelihood);

      for (let companyShutdown = 0; companyShutdown <= 5; companyShutdown++) {
        for (let likelihood = 0; likelihood <= 5; likelihood++) {
          for (const businessScale of businessScaleValues) {
            const criticalityValue = Math.round(((valueMappers.companyShutdown[companyShutdown] - minCompanyShutdown) / (maxCompanyShutdown - minCompanyShutdown)) * 5);
            const timingValue = Math.round(((valueMappers.likelihood[likelihood] - minLikelihood) / (maxLikelihood - minLikelihood)) * 5);
            const score = (valueMappers.companyShutdown[companyShutdown] * parseFloat(securityCriticalityFactor.value)) + 
                          (valueMappers.likelihood[likelihood] * parseFloat(securityTimingFactor.value)) + 
                          (businessScale / 20 * parseFloat(securityBusinessScaleFactor.value));
            permutations.push({
              category: 'Security',
              criticality: `${parameters.companyShutdown[companyShutdown]}`,
              timing: `${parameters.likelihood[likelihood]}`,
              criticalityValue: criticalityValue,
              timingValue: timingValue,
              businessScale: businessScale,
              businessScaleValue: Math.ceil(businessScale / 20),
              score: score
            });
          }
        }
      }
    }
    function generateCostOptimizationPermutations(permutations) {
      const costOptimizationBusinessScaleLimitValue = parseInt(costOptimizationBusinessScaleLimit.value);
      const businessScaleValues = [];
      for (let i = 0; i <= 5; i++) {
        businessScaleValues.push((costOptimizationBusinessScaleLimitValue / 5) * i);
      }

      const minImplementationTime = Math.min(...valueMappers.implementationTime);
      const maxImplementationTime = Math.max(...valueMappers.implementationTime);

      for (let implementationTime = 0; implementationTime <= 5; implementationTime++) {
      for (const businessScale of businessScaleValues) {
        if (businessScale <= costOptimizationBusinessScaleLimitValue) {
        const timingValue = Math.round(((valueMappers.implementationTime[implementationTime] - minImplementationTime) / (maxImplementationTime - minImplementationTime)) * 5);
        const scaledBusinessScale = (businessScale / costOptimizationBusinessScaleLimitValue) * 5;
        const score = (valueMappers.implementationTime[implementationTime] * parseFloat(costOptimizationTimingFactor.value)) + 
                (scaledBusinessScale * parseFloat(costOptimizationBusinessScaleFactor.value));
        permutations.push({
          category: 'Cost Optimization',
          criticality: '',
          timing: `${parameters.implementationTime[implementationTime]}`,
          criticalityValue: 0, // Assuming costReduction is not used for permutations
          timingValue: timingValue,
          businessScale: businessScale,
          businessScaleValue: Math.ceil(scaledBusinessScale),
          score: score
        });
        }
      }
      }
    }

    function generatePerformanceReliabilityPermutations(permutations) {
      const businessScaleValues = [0, 20, 40, 60, 80, 100];

      const minSeverity = Math.min(...valueMappers.severity);
      const maxSeverity = Math.max(...valueMappers.severity);
      const minDevelopmentTime = Math.min(...valueMappers.developmentTime);
      const maxDevelopmentTime = Math.max(...valueMappers.developmentTime);

      for (let severity = 0; severity <= 5; severity++) {
        for (let developmentTime = 0; developmentTime <= 5; developmentTime++) {
          for (const businessScale of businessScaleValues) {
            const severityValue = Math.round(((valueMappers.severity[severity] - minSeverity) / (maxSeverity - minSeverity)) * 5);
            const timingValue = Math.round(((valueMappers.developmentTime[developmentTime] - minDevelopmentTime) / (maxDevelopmentTime - minDevelopmentTime)) * 5);
            const score = (valueMappers.severity[severity] * parseFloat(performanceReliabilitySeverityFactor.value)) + 
                          (valueMappers.developmentTime[developmentTime] * parseFloat(performanceReliabilityTimingFactor.value)) + 
                          (businessScale / 20 * parseFloat(performanceReliabilityBusinessScaleFactor.value));
            permutations.push({
              category: 'Performance & Reliability',
              criticality: `${parameters.severity[severity]}`,
              timing: `${parameters.developmentTime[developmentTime]}`,
              criticalityValue: severityValue,
              timingValue: timingValue,
              businessScale: businessScale,
              businessScaleValue: Math.ceil(businessScale / 20),
              score: score
            });
          }
        }
      }
    }

    function generateDataEngineeringPermutations(permutations) {
      const businessScaleValues = [0, 20, 40, 60, 80, 100];

      const minSeverity = Math.min(...valueMappers.dataEngineeringSeverity);
      const maxSeverity = Math.max(...valueMappers.dataEngineeringSeverity);
      const minDevelopmentTime = Math.min(...valueMappers.dataEngineeringDevelopmentTime);
      const maxDevelopmentTime = Math.max(...valueMappers.dataEngineeringDevelopmentTime);

      for (let severity = 0; severity <= 5; severity++) {
        for (let developmentTime = 0; developmentTime <= 5; developmentTime++) {
          for (const businessScale of businessScaleValues) {
            const severityValue = Math.round(((valueMappers.dataEngineeringSeverity[severity] - minSeverity) / (maxSeverity - minSeverity)) * 5);
            const timingValue = Math.round(((valueMappers.dataEngineeringDevelopmentTime[developmentTime] - minDevelopmentTime) / (maxDevelopmentTime - minDevelopmentTime)) * 5);
            const score = (valueMappers.dataEngineeringSeverity[severity] * parseFloat(dataEngineeringSeverityFactor.value)) + 
                          (valueMappers.dataEngineeringDevelopmentTime[developmentTime] * parseFloat(dataEngineeringTimingFactor.value)) + 
                          (businessScale / 20 * parseFloat(dataEngineeringBusinessScaleFactor.value));
            permutations.push({
              category: 'Data Engineering',
              criticality: `${parameters.dataEngineeringSeverity[severity]}`,
              timing: `${parameters.dataEngineeringDevelopmentTime[developmentTime]}`,
              criticalityValue: severityValue,
              timingValue: timingValue,
              businessScale: businessScale,
              businessScaleValue: Math.ceil(businessScale / 20),
              score: score
            });
          }
        }
      }
    }

    function calculateScore() {
      const selectedCategory = categorySelect.value;
      let score = 0;

      if (selectedCategory === 'clientExperience') {
        const showstopper = parseInt(document.getElementById('showstopper').value) || 0;
        const frequency = parseInt(document.getElementById('frequency').value) || 0;
        const timeSpent = parseInt(document.getElementById('timeSpent').value) || 0;
        const businessScale = parseInt(document.getElementById('clientExperienceBusinessScale').value) || 0;
        score = (showstopper * parseFloat(clientExperienceCriticalityFactor.value)) + 
                (frequency / 2 * parseFloat(clientExperienceTimingFactor.value)) + 
                (timeSpent / 2 * parseFloat(clientExperienceTimingFactor.value)) + 
                (businessScale / 20 * parseFloat(clientExperienceBusinessScaleFactor.value));
      } else if (selectedCategory === 'productDelivery') {
        const dealbreaker = parseInt(document.getElementById('dealbreaker').value) || 0;
        const projectTime = parseInt(document.getElementById('projectTime').value) || 0;
        const clientTraffic = parseInt(document.getElementById('clientTraffic').value) || 0;
        const productDeliveryBusinessScaleLimitValue = parseInt(productDeliveryBusinessScaleLimit.value) || 0;
        const cappedClientTraffic = Math.min(clientTraffic, productDeliveryBusinessScaleLimitValue);
        score = (dealbreaker * parseFloat(productDeliveryCriticalityFactor.value)) + 
                (projectTime * parseFloat(productDeliveryTimingFactor.value)) + 
                (cappedClientTraffic / 20 * parseFloat(productDeliveryBusinessScaleFactor.value));
      } else if (selectedCategory === 'security') {
        const companyShutdown = parseInt(document.getElementById('companyShutdown').value) || 0;
        const likelihood = parseInt(document.getElementById('likelihood').value) || 0;
        const businessScale = parseInt(document.getElementById('securityBusinessScale').value) || 0;
        score = (companyShutdown * parseFloat(securityCriticalityFactor.value)) + 
                (likelihood * parseFloat(securityTimingFactor.value)) + 
                (businessScale / 20 * parseFloat(securityBusinessScaleFactor.value));
      } else if (selectedCategory === 'costOptimization') {
        const implementationTime = parseInt(document.getElementById('implementationTime').value) || 0;
        const businessScale = parseInt(document.getElementById('costOptimizationBusinessScale').value) || 0;
        const costOptimizationBusinessScaleLimitValue = parseInt(costOptimizationBusinessScaleLimit.value) || 0;
        const cappedBusinessScale = Math.min(businessScale, costOptimizationBusinessScaleLimitValue);
        score = (implementationTime * parseFloat(costOptimizationTimingFactor.value)) + 
                (cappedBusinessScale / costOptimizationBusinessScaleLimitValue * 5 * parseFloat(costOptimizationBusinessScaleFactor.value));
      } else if (selectedCategory === 'performanceReliability') {
        const severity = parseInt(document.getElementById('severity').value) || 0;
        const developmentTime = parseInt(document.getElementById('developmentTime').value) || 0;
        const businessScale = parseInt(document.getElementById('performanceReliabilityBusinessScale').value) || 0;
        score = (severity * parseFloat(performanceReliabilitySeverityFactor.value)) + 
                (developmentTime * parseFloat(performanceReliabilityTimingFactor.value)) + 
                (businessScale / 20 * parseFloat(performanceReliabilityBusinessScaleFactor.value));
      } else if (selectedCategory === 'dataEngineering') {
        const severity = parseInt(document.getElementById('dataEngineeringSeverity').value) || 0;
        const developmentTime = parseInt(document.getElementById('dataEngineeringDevelopmentTime').value) || 0;
        const businessScale = parseInt(document.getElementById('dataEngineeringBusinessScale').value) || 0;
        score = (severity * parseFloat(dataEngineeringSeverityFactor.value)) + 
                (developmentTime * parseFloat(dataEngineeringTimingFactor.value)) + 
                (businessScale / 20 * parseFloat(dataEngineeringBusinessScaleFactor.value));
      }

      // Scale scores to be between 1 and 5
      const maxScore = permutations.length > 0 ? permutations[0].score : 1;
      const scaleFactor = maxScore > 5 ? 5 / maxScore : 1;
        score *= scaleFactor;
      const priorityLevel = calculatePriorityLevel(score);
      document.getElementById('calculatedScore').innerText = `Score: ${score.toFixed(2)}`;
      document.getElementById('priorityLevel').innerHTML = `Priority Level: ${priorityLevel}`;
    }

    function calculatePriorityLevel(score) {
      if (score >= 4) {
        return '<span class="priority-level priority-high">High</span>';
      } else if (score >= 2.5) {
        return '<span class="priority-level priority-medium">Medium</span>';
      } else {
        return '<span class="priority-level priority-low">Low</span>';
      }
    }

    categorySelect.addEventListener('change', calculateScore);
    inputs.forEach(input => {
      input.addEventListener('change', calculateScore);
    });

    // Update factor values on slider change
    const sliders = document.querySelectorAll('input[type="range"]');
    sliders.forEach(slider => {
      slider.addEventListener('input', debounce(() => {
        updateFactorValues();
        displayPermutationTable();
        sortEntriesTable();
        calculateScore();
      }, 300));
    });

    // Sync factor values on number input change
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
      input.addEventListener('input', debounce(() => {
        syncFactorValues();
        displayPermutationTable();
        sortEntriesTable();
        calculateScore();
      }, 300));
    });

    // Save parameters
    function saveParameters() {
      saveToHistory();
      Object.keys(parameters).forEach(type => {
        const container = document.getElementById(`${type}Parameters`);
        const pairs = container.querySelectorAll('.parameter-pair');
        parameters[type] = [];
        valueMappers[type] = [];
        pairs.forEach(pair => {
          const value = parseFloat(pair.querySelector('input[type="number"]').value);
          const desc = pair.querySelector('input[type="text"]').value;
          if (!isNaN(value) && desc.trim() !== '') {
            valueMappers[type].push(value);
            parameters[type].push(desc);
          }
        });
      });
      populateDropdowns();
      displayPermutationTable();
      sortEntriesTable();
      calculateScore();
      checkStateDifference();
    }

    function sortEntriesTable() {

      entries.forEach(entry => {
        entry.updatedEntry = calculateUpdatedEntry(entry);
      });

      entries = entries.sort((a, b) => {
        const scoreA = parseFloat(a.updatedEntry?.score || a.score);
        const scoreB = parseFloat(b.updatedEntry?.score || b.score);
        return scoreB - scoreA;
      });
      filterEntries();
    }

    resetParametersButton.addEventListener('click', resetParameters);

    function addDescriptionPair(type) {
      const container = document.getElementById(`${type}Parameters`);
      const pairDiv = document.createElement('div');
      pairDiv.className = 'parameter-pair';
      pairDiv.innerHTML = `
        <input type="number" step="0.01" value="0">
        <input type="text" value="">
        <button onclick="removeDescriptionPair(this)">Remove</button>
      `;
      container.appendChild(pairDiv);
    }

    function addParameterPair(type) {
      const container = document.getElementById(`${type}Parameters`);
      const pairDiv = document.createElement('div');
      pairDiv.className = 'parameter-pair';
      pairDiv.innerHTML = `
        <input type="number" step="0.01" value="0">
        <input type="text" value="">
        <button onclick="removeParameterPair(this)">Remove</button>
      `;
      container.appendChild(pairDiv);
      pairDiv.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', debounce(saveParameters, 300));
      });
    }

    function removeDescriptionPair(button) {
      button.parentElement.remove();
    }

    function removeParameterPair(button) {
      button.parentElement.remove();
      saveParameters();
    }

    function populateDescriptionFields() {
      Object.keys(parameters).forEach(type => {
        const container = document.getElementById(`${type}Parameters`);
        container.innerHTML = '';
        parameters[type].forEach((desc, index) => {
          const pairDiv = document.createElement('div');
          pairDiv.className = 'parameter-pair';
          pairDiv.innerHTML = `
            <input type="number" step="0.01" value="${valueMappers[type][index]}">
            <input type="text" value="${desc}">
            <button onclick="removeParameterPair(this)">Remove</button>
          `;
          container.appendChild(pairDiv);
          pairDiv.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', debounce(saveParameters, 300));
          });
        });
      });
    }

    function populateParameterFields() {
      Object.keys(parameters).forEach(type => {
        const container = document.getElementById(`${type}Parameters`);
        container.innerHTML = '';
        parameters[type].forEach((desc, index) => {
          const pairDiv = document.createElement('div');
          pairDiv.className = 'parameter-pair';
          pairDiv.innerHTML = `
            <input type="number" step="0.01" value="${valueMappers[type][index]}">
            <input type="text" value="${desc}">
            <button onclick="removeParameterPair(this)">Remove</button>
          `;
          container.appendChild(pairDiv);
          pairDiv.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', debounce(saveParameters, 300));
          });
        });
      });
    }

    // Initial call to populate the table and calculate the score
    populateDescriptionFields();
    populateParameterFields();
    populateDropdowns();
    displayPermutationTable();
    calculateScore();
    updateFactorValues();

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const later = () => {
          clearTimeout(timeout);
          func.apply(this, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function getCurrentState() {
      return JSON.stringify({
        category: categorySelect.value,
        clientExperienceCriticalityFactor: clientExperienceCriticalityFactor.value,
        clientExperienceTimingFactor: clientExperienceTimingFactor.value,
        clientExperienceBusinessScaleFactor: clientExperienceBusinessScaleFactor.value,
        productDeliveryCriticalityFactor: productDeliveryCriticalityFactor.value,
        productDeliveryTimingFactor: productDeliveryTimingFactor.value,
        productDeliveryBusinessScaleFactor: productDeliveryBusinessScaleFactor.value,
        productDeliveryBusinessScaleLimit: productDeliveryBusinessScaleLimit.value,
        securityCriticalityFactor: securityCriticalityFactor.value,
        securityTimingFactor: securityTimingFactor.value,
        securityBusinessScaleFactor: securityBusinessScaleFactor.value,
        costOptimizationTimingFactor: costOptimizationTimingFactor.value,
        costOptimizationBusinessScaleFactor: costOptimizationBusinessScaleFactor.value,
        costOptimizationBusinessScaleLimit: costOptimizationBusinessScaleLimit.value,
        performanceReliabilitySeverityFactor: performanceReliabilitySeverityFactor.value,
        performanceReliabilityTimingFactor: performanceReliabilityTimingFactor.value,
        performanceReliabilityBusinessScaleFactor: performanceReliabilityBusinessScaleFactor.value,
        dataEngineeringSeverityFactor: dataEngineeringSeverityFactor.value,
        dataEngineeringTimingFactor: dataEngineeringTimingFactor.value,
        dataEngineeringBusinessScaleFactor: dataEngineeringBusinessScaleFactor.value,
        parameters: parameters,
        valueMappers: valueMappers
      });
    }

  document.querySelectorAll('.tabs .tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const parent = this.closest('.tabs').parentElement;
      const tabContents = parent.querySelectorAll('.tab-content');
      parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      this.classList.add('active');
      const activeTabContent = document.getElementById(this.dataset.tab);
      activeTabContent.classList.add('active');
    // Activate the first nested tab and its content
    const firstNestedTab = activeTabContent.querySelector('.nested-tabs .nested-tab');
    if (firstNestedTab) {
      activeTabContent.querySelectorAll('.nested-tab').forEach(nt => nt.classList.remove('active'));
      activeTabContent.querySelectorAll('.nested-tab-content').forEach(ntc => ntc.classList.remove('active'));
      firstNestedTab.classList.add('active');
      document.getElementById(firstNestedTab.dataset.tab).classList.add('active');

      // Activate the first third tab and its content
      const firstThirdTab = document.querySelector(`#${firstNestedTab.dataset.tab} .third-tabs .third-tab`);
      if (firstThirdTab) {
        document.querySelectorAll(`#${firstNestedTab.dataset.tab} .third-tab`).forEach(tt => tt.classList.remove('active'));
        document.querySelectorAll(`#${firstNestedTab.dataset.tab} .third-tab-content`).forEach(ttc => ttc.classList.remove('active'));
        firstThirdTab.classList.add('active');
        document.getElementById(firstThirdTab.dataset.tab).classList.add('active');
      }
    }

      updateURL(null, this.dataset.tab);
    });
  });

  document.querySelectorAll('.nested-tabs .nested-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const parent = this.closest('.nested-tabs').parentElement;
      const tabContents = parent.querySelectorAll('.nested-tab-content');
      parent.querySelectorAll('.nested-tab').forEach(t => t.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
    // Activate the first third tab and its content
    const firstThirdTab = parent.querySelector('.third-tabs .third-tab');
    if (firstThirdTab) {
      parent.querySelectorAll('.third-tab').forEach(tt => tt.classList.remove('active'));
      parent.querySelectorAll('.third-tab-content').forEach(ttc => ttc.classList.remove('active'));
      firstThirdTab.classList.add('active');
      document.getElementById(firstThirdTab.dataset.tab).classList.add('active');
    }

      const currentTab = new URL(window.location).searchParams.get('tab');
      updateURL(null, currentTab, this.dataset.tab);
    });
  });

  document.querySelectorAll('.third-tabs .third-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const parent = this.closest('.third-tabs').parentElement;
      const tabContents = parent.querySelectorAll('.third-tab-content');
      parent.querySelectorAll('.third-tab').forEach(t => t.classList.remove('active'));
      tabContents.forEach(ttc => ttc.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
      const currentTab = new URL(window.location).searchParams.get('tab');
      const currentNestedTab = new URL(window.location).searchParams.get('nestedTab');
      updateURL(null, currentTab, currentNestedTab, this.dataset.tab);
    });
  });

    document.getElementById('exportStateButton').addEventListener('click', function() {
      const state = localStorage.getItem('triageState');
      const blob = new Blob([state], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'triageState.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('importStateButton').addEventListener('click', function() {
      document.getElementById('importStateInput').click();
    });

    document.getElementById('importStateInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const state = JSON.parse(e.target.result);
          localStorage.setItem('triageState', JSON.stringify(state));
          loadState();
          populateDropdowns();
        };
        reader.readAsText(file);
      }
    });

    saveStateButton.addEventListener('click', function() {
      if (confirm('Are you sure you want to save the current state?')) {
        saveStateToFirestore();
        checkStateDifference();
      }
    });

    resetStateButton.addEventListener('click', function() {
      if (confirm('Are you sure you want to reset to the saved state?')) {
        loadState();
        checkStateDifference();
        sortEntriesTable();
      }
    });

    window.addEventListener('beforeunload', function(event) {
      const currentState = getCurrentState();
      const savedState = localStorage.getItem('triageState');
      if (currentState !== savedState) {
        event.preventDefault();
        event.returnValue = '';
      }
    });

    // Initial call to check state difference
    checkStateDifference();

    function generateUniqueId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    function saveEntry() {
      saveToHistory();
      const description = document.getElementById('projectDescription').value;
      const category = categorySelect.options[categorySelect.selectedIndex].text;
      const criticality = document.querySelector(`#${categorySelect.value}Fields select`).options[document.querySelector(`#${categorySelect.value}Fields select`).selectedIndex].text;
      let timing;
      if (categorySelect.value === 'clientExperience') {
        timing = `${document.querySelectorAll(`#${categorySelect.value}Fields select`)[1].options[document.querySelectorAll(`#${categorySelect.value}Fields select`)[1].selectedIndex].text} | ${document.querySelectorAll(`#${categorySelect.value}Fields select`)[2].options[document.querySelectorAll(`#${categorySelect.value}Fields select`)[2].selectedIndex].text}`;
      } else if (categorySelect.value === 'costOptimization') {
        timing = document.querySelectorAll(`#${categorySelect.value}Fields select`)[0].options[document.querySelectorAll(`#${categorySelect.value}Fields select`)[0].selectedIndex].text;
      } else {
        timing = document.querySelectorAll(`#${categorySelect.value}Fields select`)[1].options[document.querySelectorAll(`#${categorySelect.value}Fields select`)[1].selectedIndex].text;
      }
      const businessScale = document.querySelector(`#${categorySelect.value}Fields input[type="number"]`).value;
      const googleDocLink = document.getElementById('googleDocLink').value;
      const jiraTicketLink = document.getElementById('jiraTicketLink').value;
      const score = document.getElementById('calculatedScore').innerText.split(': ')[1];
      const priorityLevel = calculatePriorityLevel(parseFloat(score));
      const namespaceParam = new URLSearchParams(window.location.search).get('namespace');
      const namespaces = namespaceParam ? namespaceParam.split(',').map(ns => ns.trim()) : ['default'];
      const namespace = namespaces.length > 1 ? document.getElementById('namespaceSelect').value : namespaces[0];

      if (editingRow !== null) {
        entries[editingRow] = {
          ...entries[editingRow],
          description,
          category,
          criticality,
          timing,
          businessScale,
          googleDocLink,
          jiraTicketLink,
          score,
          priorityLevel,
          namespace
        };
        editingRow = null;
        saveEntryButton.textContent = 'Save Entry';
        saveEntryButton.classList.remove('update-entry-button');
        saveEntryButton.classList.add('save-entry-button');
        cancelUpdateButton.style.display = 'none';
      } else {
        const newEntry = {
          id: generateUniqueId(),
          description,
          category,
          criticality,
          timing,
          businessScale,
          googleDocLink,
          jiraTicketLink,
          score,
          priorityLevel,
          namespace,
          status: 'Not Started' // Default status
        };
        newEntry.updatedEntry = calculateUpdatedEntry(newEntry);
        entries.push(newEntry);
      }

      // Enable the namespace dropdown
      const namespaceSelect = document.getElementById('namespaceSelect');
      if (namespaceSelect) {
        namespaceSelect.disabled = false;
      }

      sortEntriesTable();
      saveEntriesToLocalStorage();
    }

    saveEntryButton.addEventListener('click', saveEntry);

    cancelUpdateButton.addEventListener('click', function() {
      editingRow = null;
      saveEntryButton.textContent = 'Save Entry';
      saveEntryButton.classList.remove('update-entry-button');
      saveEntryButton.classList.add('save-entry-button');
      cancelUpdateButton.style.display = 'none';
      document.getElementById('projectDescription').value = '';
      categorySelect.value = 'clientExperience';
      categorySelect.dispatchEvent(new Event('change'));

      // Enable the namespace dropdown
      const namespaceSelect = document.getElementById('namespaceSelect');
      if (namespaceSelect) {
        namespaceSelect.disabled = false;
      }

      sortEntriesTable();
    });

    function renderEntriesTable(filteredEntries = entries) {
      const namespaceParam = new URLSearchParams(window.location.search).get('namespace');
      const namespaces = namespaceParam ? namespaceParam.split(',').map(ns => ns.trim()) : ['default'];
      entriesTableBody.innerHTML = '';
      filteredEntries.forEach((entry, index) => {
        const row = document.createElement('tr');
        row.className = (editingRow !== null && entries[editingRow].id === entry.id) ? 'highlight-row' : '';
        const priorityChangeIcon = getPriorityChangeIcon(entry.priorityLevel, entry.updatedEntry.priorityLevel);
        const googleDocIcon = entry.googleDocLink ? `<a href="${entry.googleDocLink}" target="_blank"><img src="google-docs.png" class="icon" alt="Google Doc"></a>` : '';
        const jiraTicketIcon = entry.jiraTicketLink ? `<a href="${entry.jiraTicketLink}" target="_blank"><img src="jira.png" class="icon" alt="Jira Ticket"></a>`: '';
        row.innerHTML = `
          <td>${entry.description} ${googleDocIcon} ${jiraTicketIcon}</td>
          <td>${entry.category}</td>
          <td>${formatParameterChange(entry.criticality, entry.updatedEntry.criticality)}</td>
          <td>${formatParameterChange(entry.timing, entry.updatedEntry.timing)}</td>
          <td>${formatParameterChange(entry.businessScale, entry.updatedEntry.businessScale)}</td>
          <td>${formatScoreChange(entry.score, entry.updatedEntry.score)}</td>
          <td>${entry.updatedEntry.priorityLevel}${priorityChangeIcon}</td>
          <td>
            <select class="status-dropdown ${getStatusClass(entry.status)}" onchange="updateEntryStatus('${entry.id}', this.value)">
              <option value="Not Started" ${entry.status === 'Not Started' ? 'selected' : ''} class="status-not-started">Not Started</option>
              <option value="WIP" ${entry.status === 'WIP' ? 'selected' : ''} class="status-wip">WIP</option>
              <option value="Deployed" ${entry.status === 'Deployed' ? 'selected' : ''} class="status-deployed">Deployed</option>
              <option value="On Hold" ${entry.status === 'On Hold' ? 'selected' : ''} class="status-on-hold">On Hold</option>
              <option value="Cancelled" ${entry.status === 'Cancelled' ? 'selected' : ''} class="status-cancelled">Cancelled</option>
            </select>
          </td>
          ${namespaces.length > 1 ? `<td>${entry.namespace}</td>` : ''}
          <td>
            <button class="edit-button" onclick="editEntry('${entry.id}')">Edit</button>
            <button class="delete-button" onclick="deleteEntry('${entry.id}')">Delete</button>
          </td>
        `;
        entriesTableBody.appendChild(row);
      });

      // Show/hide namespace header
      const namespaceHeader = document.getElementById('namespace-header');
      if (namespaces.length > 1) {
        namespaceHeader.style.display = 'table-cell';
      } else {
        namespaceHeader.style.display = 'none';
      }
    }

    function getStatusClass(status) {
      switch (status) {
        case 'Not Started':
          return 'status-not-started';
        case 'WIP':
          return 'status-wip';
        case 'Deployed':
          return 'status-deployed';
        case 'On Hold':
          return 'status-on-hold';
        case 'Cancelled':
          return 'status-cancelled';
        default:
          return 'status-not-started';
      }
    }

    function getPriorityChangeIcon(originalPriority, updatedPriority) {
      const originalLevel = getPriorityLevel(originalPriority);
      const updatedLevel = getPriorityLevel(updatedPriority);
      const difference = Math.abs(updatedLevel - originalLevel);
      let icons = '';
      if (originalLevel < updatedLevel) {
      icons = '<span class="icon-up">&#9650;</span>'.repeat(difference); // Green up arrows
      } else if (originalLevel > updatedLevel) {
      icons = '<span class="icon-down">&#9660;</span>'.repeat(difference); // Red down arrows
      }
      return icons;
    }

    function getPriorityLevel(priority) {
      if (priority.includes('High')) {
        return 3;
      } else if (priority.includes('Medium')) {
        return 2;
      } else {
        return 1;
      }
    }

    function formatParameterChange(original, updated) {
      const originalValue = parseFloat(original.toString().split(' ')[0].replace(/[^0-9.-]+/g, ''));
      const updatedValue = parseFloat(updated.toString().split(' ')[0].replace(/[^0-9.-]+/g, ''));
      const difference = updatedValue - originalValue;
      const differenceText = difference > 0 ? `(+${difference.toFixed(2)})` : `(${difference.toFixed(2)})`;
      const differenceClass = difference > 0 ? 'positive-change' : 'negative-change';
      return difference !== 0 ? `${original} <span class="${differenceClass}">${differenceText}</span>` : `${original}`;
    }

    function formatScoreChange(original, updated) {
      const originalValue = parseFloat(original);
      const updatedValue = parseFloat(updated);
      const difference = updatedValue - originalValue;
      const differenceText = difference > 0 ? `(+${difference.toFixed(2)})` : `(${difference.toFixed(2)})`;
      const differenceClass = difference > 0 ? 'positive-change' : 'negative-change';
      return difference !== 0 ? `${originalValue.toFixed(2)} <span class="${differenceClass}">${differenceText}</span>` : originalValue.toFixed(2);
    }

    function calculateUpdatedEntry(entry) {
      const category = entry.category.toLowerCase().replace(/[\s&]+/g, '');
      let score = 0;
      let criticalityValue = 0;
      let timingValue = 0;
      let businessScaleValue = parseFloat(entry.businessScale);
      let updatedCriticality = entry.criticality;
      let updatedTiming = entry.timing;

      if (category === 'clientexperience') {
        criticalityValue = findClosestValue(valueMappers.showstopper, entry.criticality, parameters.showstopper);
        const frequencyValue = findClosestValue(valueMappers.frequency, entry.timing.split(' | ')[0], parameters.frequency);
        const timeSpentValue = findClosestValue(valueMappers.timeSpent, entry.timing.split(' | ')[1], parameters.timeSpent);
        timingValue = (frequencyValue + timeSpentValue) / 2;
        score = (criticalityValue * parseFloat(clientExperienceCriticalityFactor.value)) + 
          (frequencyValue / 2 * parseFloat(clientExperienceTimingFactor.value)) + 
          (timeSpentValue / 2 * parseFloat(clientExperienceTimingFactor.value)) + 
          (businessScaleValue / 20 * parseFloat(clientExperienceBusinessScaleFactor.value));
        updatedCriticality = `${criticalityValue} - ${parameters.showstopper[valueMappers.showstopper.indexOf(criticalityValue)]}`;
        updatedTiming = `${frequencyValue} - ${parameters.frequency[valueMappers.frequency.indexOf(frequencyValue)]} | ${timeSpentValue} - ${parameters.timeSpent[valueMappers.timeSpent.indexOf(timeSpentValue)]}`;
      } else if (category === 'productdelivery') {
        criticalityValue = findClosestValue(valueMappers.dealbreaker, entry.criticality, parameters.dealbreaker);
        timingValue = findClosestValue(valueMappers.projectTime, entry.timing, parameters.projectTime);
        score = (criticalityValue * parseFloat(productDeliveryCriticalityFactor.value)) + 
          (timingValue * parseFloat(productDeliveryTimingFactor.value)) + 
          (businessScaleValue / 20 * parseFloat(productDeliveryBusinessScaleFactor.value));
        updatedCriticality = `${criticalityValue} - ${parameters.dealbreaker[valueMappers.dealbreaker.indexOf(criticalityValue)]}`;
        updatedTiming = `${timingValue} - ${parameters.projectTime[valueMappers.projectTime.indexOf(timingValue)]}`;
      } else if (category === 'security') {
        criticalityValue = findClosestValue(valueMappers.companyShutdown, entry.criticality, parameters.companyShutdown);
        timingValue = findClosestValue(valueMappers.likelihood, entry.timing, parameters.likelihood);
        score = (criticalityValue * parseFloat(securityCriticalityFactor.value)) + 
          (timingValue * parseFloat(securityTimingFactor.value)) + 
          (businessScaleValue / 20 * parseFloat(securityBusinessScaleFactor.value));
        updatedCriticality = `${criticalityValue} - ${parameters.companyShutdown[valueMappers.companyShutdown.indexOf(criticalityValue)]}`;
        updatedTiming = `${timingValue} - ${parameters.likelihood[valueMappers.likelihood.indexOf(timingValue)]}`;
      } else if (category === 'costoptimization') {
        timingValue = findClosestValue(valueMappers.implementationTime, entry.timing, parameters.implementationTime);
        score = (timingValue * parseFloat(costOptimizationTimingFactor.value)) + 
          (businessScaleValue / parseFloat(costOptimizationBusinessScaleLimit.value) * 5 * parseFloat(costOptimizationBusinessScaleFactor.value));
        updatedTiming = `${timingValue} - ${parameters.implementationTime[valueMappers.implementationTime.indexOf(timingValue)]}`;
      } else if (category === 'performancereliability') {
        criticalityValue = findClosestValue(valueMappers.severity, entry.criticality, parameters.severity);
        timingValue = findClosestValue(valueMappers.developmentTime, entry.timing, parameters.developmentTime);
        score = (criticalityValue * parseFloat(performanceReliabilitySeverityFactor.value)) + 
          (timingValue * parseFloat(performanceReliabilityTimingFactor.value)) + 
          (businessScaleValue / 20 * parseFloat(performanceReliabilityBusinessScaleFactor.value));
        updatedCriticality = `${criticalityValue} - ${parameters.severity[valueMappers.severity.indexOf(criticalityValue)]}`;
        updatedTiming = `${timingValue} - ${parameters.developmentTime[valueMappers.developmentTime.indexOf(timingValue)]}`;
      } else if (category === 'dataengineering') {
        criticalityValue = findClosestValue(valueMappers.dataEngineeringSeverity, entry.criticality, parameters.dataEngineeringSeverity);
        timingValue = findClosestValue(valueMappers.dataEngineeringDevelopmentTime, entry.timing, parameters.dataEngineeringDevelopmentTime);
        score = (criticalityValue * parseFloat(dataEngineeringSeverityFactor.value)) + 
          (timingValue * parseFloat(dataEngineeringTimingFactor.value)) + 
          (businessScaleValue / 20 * parseFloat(dataEngineeringBusinessScaleFactor.value));
        updatedCriticality = `${criticalityValue} - ${parameters.dataEngineeringSeverity[valueMappers.dataEngineeringSeverity.indexOf(criticalityValue)]}`;
        updatedTiming = `${timingValue} - ${parameters.dataEngineeringDevelopmentTime[valueMappers.dataEngineeringDevelopmentTime.indexOf(timingValue)]}`;
      }

      // Scale scores to be between 1 and 5
      const maxScore = permutations.length > 0 ? permutations[0].score : 1;
      const scaleFactor = maxScore > 5 ? 5 / maxScore : 1;
      score *= scaleFactor;
      const priorityLevel = calculatePriorityLevel(score);

      return {
        criticality: updatedCriticality,
        timing: updatedTiming,
        businessScale: businessScaleValue,
        score: score.toFixed(2),
        priorityLevel: priorityLevel
      };
    }

    function editEntry(id) {
      const entry = entries.find(entry => entry.id === id);
      document.getElementById('projectDescription').value = entry.description;
      categorySelect.value = entry.category.charAt(0).toLowerCase() + entry.category.slice(1).replace(/[\s&]+/g, '');
      categorySelect.dispatchEvent(new Event('change'));

      const categoryFields = document.getElementById(`${categorySelect.value}Fields`);
      const selects = categoryFields.querySelectorAll('select');
      const inputs = categoryFields.querySelectorAll('input[type="number"]');

      if (categorySelect.value === 'clientExperience') {
        selects[0].value = findClosestValue(valueMappers.showstopper, entry.criticality, parameters.showstopper);
        selects[1].value = findClosestValue(valueMappers.frequency, entry.timing.split(' | ')[0], parameters.frequency);
        selects[2].value = findClosestValue(valueMappers.timeSpent, entry.timing.split(' | ')[1], parameters.timeSpent);
      } else if (categorySelect.value === 'productDelivery') {
        selects[0].value = findClosestValue(valueMappers.dealbreaker, entry.criticality, parameters.dealbreaker);
        selects[1].value = findClosestValue(valueMappers.projectTime, entry.timing, parameters.projectTime);
      } else if (categorySelect.value === 'security') {
        selects[0].value = findClosestValue(valueMappers.companyShutdown, entry.criticality, parameters.companyShutdown);
        selects[1].value = findClosestValue(valueMappers.likelihood, entry.timing, parameters.likelihood);
      } else if (categorySelect.value === 'costOptimization') {
        selects[0].value = findClosestValue(valueMappers.implementationTime, entry.timing, parameters.implementationTime);
      } else if (categorySelect.value === 'performanceReliability') {
        selects[0].value = findClosestValue(valueMappers.severity, entry.criticality, parameters.severity);
        selects[1].value = findClosestValue(valueMappers.developmentTime, entry.timing, parameters.developmentTime);
      } else if (categorySelect.value === 'dataEngineering') {
        selects[0].value = findClosestValue(valueMappers.dataEngineeringSeverity, entry.criticality, parameters.dataEngineeringSeverity);
        selects[1].value = findClosestValue(valueMappers.dataEngineeringDevelopmentTime, entry.timing, parameters.dataEngineeringDevelopmentTime);
      }

      inputs[0].value = entry.businessScale;
      document.getElementById('googleDocLink').value = entry.googleDocLink || '';
      document.getElementById('jiraTicketLink').value = entry.jiraTicketLink || '';

      // Set the namespace dropdown value and disable it
      const namespaceSelect = document.getElementById('namespaceSelect');
      if (namespaceSelect) {
        namespaceSelect.value = entry.namespace;
        namespaceSelect.disabled = true;
      }

      calculateScore();

      editingRow = entries.findIndex(entry => entry.id === id);
      saveEntryButton.textContent = 'Update Entry';
      saveEntryButton.classList.remove('save-entry-button');
      saveEntryButton.classList.add('update-entry-button');
      cancelUpdateButton.style.display = 'inline-block';
      sortEntriesTable();
    }

    // Expose the function to the global scope
    window.editEntry = editEntry;
    window.deleteEntry = deleteEntry;
    window.addParameterPair = addParameterPair;
    window.removeParameterPair = removeParameterPair;
    window.filterValue = filterValue;
    window.updateEntryStatus = updateEntryStatus;

    function deleteEntry(id) {
      saveToHistory();
      if (confirm('Are you sure you want to delete this entry?')) {
        const entry = entries.find(entry => entry.id === id);
        if (entry) {
          entries = entries.filter(entry => entry.id !== id);
          sortEntriesTable();
          saveEntriesToLocalStorage();
          deleteEntryFromFirestore(entry.namespace, id);
        }
      }
    }

    async function deleteEntryFromFirestore(namespace, id) {
      const entryRef = doc(db, "entries", namespace, "data", id);
      await deleteDoc(entryRef);
      console.log("Entry deleted from Firestore");
    }

    async function saveEntriesToLocalStorage() {
      const namespace = namespaceInput.value.trim() || new URLSearchParams(window.location.search).get('namespace') || "default";
      await saveEntriesToFirestore(namespace);
    }

    async function loadEntriesFromLocalStorage() {
      await loadEntriesFromFirestore();
    }

    function copyTableToClipboard() {
      const table = document.getElementById('entriesTable');
      const rows = table.querySelectorAll('tbody tr');
      let clipboardText = '';
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowText = Array.from(cells).slice(0, -1).map(cell => cell.innerText).join('\t'); // Exclude the last cell (Actions)
        clipboardText += rowText + '\n';
      });
      navigator.clipboard.writeText(clipboardText).then(() => {
        copyTableButton.innerText = 'Copied!';
        copyTableButton.style.backgroundColor = '#4cae4c';
        copyTableButton.disabled = true;
        setTimeout(() => {
          copyTableButton.innerText = 'Copy Table';
          copyTableButton.disabled = false;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
      });
    }

    copyTableButton.addEventListener('click', copyTableToClipboard);

    document.addEventListener('copy', function(event) {
      if (document.activeElement === document.body && !window.getSelection().toString()) {
        copyTableToClipboard();
      }
    });

    function updateEntryScores() {
      entries.forEach(entry => {
        const category = entry.category.toLowerCase().replace(/[\s&]+/g, '');
        let score = 0;
        let criticalityValue = 0;
        let timingValue = 0;
        let businessScaleValue = parseFloat(entry.businessScale);
        if (category === 'clientexperience') {
          criticalityValue = findClosestValue(valueMappers.showstopper, entry.criticality, parameters.showstopper);
          const frequencyValue = findClosestValue(valueMappers.frequency, entry.timing.split(' | ')[0], parameters.frequency);
          const timeSpentValue = findClosestValue(valueMappers.timeSpent, entry.timing.split(' | ')[1], parameters.timeSpent);
          timingValue = (frequencyValue + timeSpentValue) / 2;
          score = (criticalityValue * parseFloat(clientExperienceCriticalityFactor.value)) + 
            (frequencyValue / 2 * parseFloat(clientExperienceTimingFactor.value)) + 
            (timeSpentValue / 2 * parseFloat(clientExperienceTimingFactor.value)) + 
            (businessScaleValue / 20 * parseFloat(clientExperienceBusinessScaleFactor.value));
          entry.criticality = `${criticalityValue} - ${parameters.showstopper[valueMappers.showstopper.indexOf(criticalityValue)]}`;
          entry.timing = `${frequencyValue} - ${parameters.frequency[valueMappers.frequency.indexOf(frequencyValue)]} | ${timeSpentValue} - ${parameters.timeSpent[valueMappers.timeSpent.indexOf(timeSpentValue)]}`;
        } else if (category === 'productdelivery') {
          criticalityValue = findClosestValue(valueMappers.dealbreaker, entry.criticality, parameters.dealbreaker);
          timingValue = findClosestValue(valueMappers.projectTime, entry.timing, parameters.projectTime);
          score = (criticalityValue * parseFloat(productDeliveryCriticalityFactor.value)) + 
            (timingValue * parseFloat(productDeliveryTimingFactor.value)) + 
            (businessScaleValue / 20 * parseFloat(productDeliveryBusinessScaleFactor.value));
          entry.criticality = `${criticalityValue} - ${parameters.dealbreaker[valueMappers.dealbreaker.indexOf(criticalityValue)]}`;
          entry.timing = `${timingValue} - ${parameters.projectTime[valueMappers.projectTime.indexOf(timingValue)]}`;
        } else if (category === 'security') {
          criticalityValue = findClosestValue(valueMappers.companyShutdown, entry.criticality, parameters.companyShutdown);
          timingValue = findClosestValue(valueMappers.likelihood, entry.timing, parameters.likelihood);
          score = (criticalityValue * parseFloat(securityCriticalityFactor.value)) + 
            (timingValue * parseFloat(securityTimingFactor.value)) + 
            (businessScaleValue / 20 * parseFloat(securityBusinessScaleFactor.value));
          entry.criticality = `${criticalityValue} - ${parameters.companyShutdown[valueMappers.companyShutdown.indexOf(criticalityValue)]}`;
          entry.timing = `${timingValue} - ${parameters.likelihood[valueMappers.likelihood.indexOf(timingValue)]}`;
        } else if (category === 'costoptimization') {
          timingValue = findClosestValue(valueMappers.implementationTime, entry.timing, parameters.implementationTime);
          score = (timingValue * parseFloat(costOptimizationTimingFactor.value)) + 
            (businessScaleValue / parseFloat(costOptimizationBusinessScaleLimit.value) * 5 * parseFloat(costOptimizationBusinessScaleFactor.value));
          entry.timing = `${timingValue} - ${parameters.implementationTime[valueMappers.implementationTime.indexOf(timingValue)]}`;
        } else if (category === 'performancereliability') {
          criticalityValue = findClosestValue(valueMappers.severity, entry.criticality, parameters.severity);
          timingValue = findClosestValue(valueMappers.developmentTime, entry.timing, parameters.developmentTime);
          score = (criticalityValue * parseFloat(performanceReliabilitySeverityFactor.value)) + 
            (timingValue * parseFloat(performanceReliabilityTimingFactor.value)) + 
            (businessScaleValue / 20 * parseFloat(performanceReliabilityBusinessScaleFactor.value));
          entry.criticality = `${criticalityValue} - ${parameters.severity[valueMappers.severity.indexOf(criticalityValue)]}`;
          entry.timing = `${timingValue} - ${parameters.developmentTime[valueMappers.developmentTime.indexOf(timingValue)]}`;
        } else if (category === 'dataengineering') {
          criticalityValue = findClosestValue(valueMappers.dataEngineeringSeverity, entry.criticality, parameters.dataEngineeringSeverity);
          timingValue = findClosestValue(valueMappers.dataEngineeringDevelopmentTime, entry.timing, parameters.dataEngineeringDevelopmentTime);
          score = (criticalityValue * parseFloat(dataEngineeringSeverityFactor.value)) + 
            (timingValue * parseFloat(dataEngineeringTimingFactor.value)) + 
            (businessScaleValue / 20 * parseFloat(dataEngineeringBusinessScaleFactor.value));
          entry.criticality = `${criticalityValue} - ${parameters.dataEngineeringSeverity[valueMappers.dataEngineeringSeverity.indexOf(criticalityValue)]}`;
          entry.timing = `${timingValue} - ${parameters.dataEngineeringDevelopmentTime[valueMappers.dataEngineeringDevelopmentTime.indexOf(timingValue)]}`;
        }

        // Scale scores to be between 1 and 5
        const maxScore = permutations.length > 0 ? permutations[0].score : 1;
        const scaleFactor = maxScore > 5 ? 5 / maxScore : 1;
        score *= scaleFactor;
        entry.score = score.toFixed(2);
        entry.priorityLevel = calculatePriorityLevel(score);
      });

      // Sort entries by score
      sortEntriesTable();
      saveEntriesToLocalStorage();
    }

    function findClosestValue(array, value, descriptions) {
      const exactMatchIndex = descriptions.findIndex(desc => desc === value.split(' - ')[1]);
      if (exactMatchIndex !== -1) {
        return array[exactMatchIndex];
      }

      const index = array.findIndex(v => v === parseFloat(value.split(' - ')[0]));
      if (index !== -1) return array[index];

      let closest = array[0];
      let closestDiff = Math.abs(array[0] - parseFloat(value.split(' - ')[0]));
      for (let i = 1; i < array.length; i++) {
        const diff = Math.abs(array[i] - parseFloat(value.split(' - ')[0]));
        if (diff < closestDiff) {
          closest = array[i];
          closestDiff = diff;
        }
      }
      return closest;
    }

    document.addEventListener('paste', function(event) {
      if (document.activeElement === document.body) {
        const clipboardData = event.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('Text');

        if (pastedData) {
          
          const rows = pastedData.trim().split('\n');
          const newEntries = rows.map(row => {
            const cells = row.split('\t');
            if (cells.length !== 7) {
              return;
            }
            return {
              id: generateUniqueId(),
              description: cells[0],
              category: cells[1],
              criticality: cells[2],
              timing: cells[3],
              businessScale: cells[4],
              score: cells[5],
              priorityLevel: cells[6]
            };
          }).filter(entry => entry);

          if (newEntries.length) {
            entries = newEntries;
            sortEntriesTable();
            saveEntriesToLocalStorage();
            checkStateDifference();
            copyTableButton.innerText = 'Pasted!';
            copyTableButton.disabled = true;
            setTimeout(() => {
              copyTableButton.innerText = 'Copy Table';
              copyTableButton.disabled = false;
            }, 2000);
          } else {
            alert('Invalid data format. Please make sure you are pasting the correct number of columns.');
          }
        }
      }
    });

    let historyStack = [];
    let redoStack = [];

    function saveToHistory() {
      const currentState = {
        entries: JSON.parse(JSON.stringify(entries)),
        parameters: JSON.parse(JSON.stringify(parameters)),
        valueMappers: JSON.parse(JSON.stringify(valueMappers)),
        factors: {
          clientExperienceCriticalityFactor: clientExperienceCriticalityFactor.value,
          clientExperienceTimingFactor: clientExperienceTimingFactor.value,
          clientExperienceBusinessScaleFactor: clientExperienceBusinessScaleFactor.value,
          productDeliveryCriticalityFactor: productDeliveryCriticalityFactor.value,
          productDeliveryTimingFactor: productDeliveryTimingFactor.value,
          productDeliveryBusinessScaleFactor: productDeliveryBusinessScaleFactor.value,
          productDeliveryBusinessScaleLimit: productDeliveryBusinessScaleLimit.value,
          securityCriticalityFactor: securityCriticalityFactor.value,
          securityTimingFactor: securityTimingFactor.value,
          securityBusinessScaleFactor: securityBusinessScaleFactor.value,
          costOptimizationTimingFactor: costOptimizationTimingFactor.value,
          costOptimizationBusinessScaleFactor: costOptimizationBusinessScaleFactor.value,
          costOptimizationBusinessScaleLimit: costOptimizationBusinessScaleLimit.value,
          performanceReliabilitySeverityFactor: performanceReliabilitySeverityFactor.value,
          performanceReliabilityTimingFactor: performanceReliabilityTimingFactor.value,
          performanceReliabilityBusinessScaleFactor: performanceReliabilityBusinessScaleFactor.value,
          dataEngineeringSeverityFactor: dataEngineeringSeverityFactor.value,
          dataEngineeringTimingFactor: dataEngineeringTimingFactor.value,
          dataEngineeringBusinessScaleFactor: dataEngineeringBusinessScaleFactor.value
        }
      };
      historyStack.push(currentState);
      redoStack = []; // Clear redo stack on new action
      saveHistoryToLocalStorage();
    }

    function saveHistoryToLocalStorage() {
      localStorage.setItem('historyStack', JSON.stringify(historyStack));
      localStorage.setItem('redoStack', JSON.stringify(redoStack));
    }

    function loadHistoryFromLocalStorage() {
      const storedHistoryStack = JSON.parse(localStorage.getItem('historyStack')) || [];
      const storedRedoStack = JSON.parse(localStorage.getItem('redoStack')) || [];
      historyStack = storedHistoryStack;
      redoStack = storedRedoStack;
    }

    function undo() {
      if (historyStack.length > 0) {
        const lastState = historyStack.pop();
        redoStack.push({
          entries: JSON.parse(JSON.stringify(entries)),
          parameters: JSON.parse(JSON.stringify(parameters)),
          valueMappers: JSON.parse(JSON.stringify(valueMappers)),
          factors: {
            clientExperienceCriticalityFactor: clientExperienceCriticalityFactor.value,
            clientExperienceTimingFactor: clientExperienceTimingFactor.value,
            clientExperienceBusinessScaleFactor: clientExperienceBusinessScaleFactor.value,
            productDeliveryCriticalityFactor: productDeliveryCriticalityFactor.value,
            productDeliveryTimingFactor: productDeliveryTimingFactor.value,
            productDeliveryBusinessScaleFactor: productDeliveryBusinessScaleFactor.value,
            productDeliveryBusinessScaleLimit: productDeliveryBusinessScaleLimit.value,
            securityCriticalityFactor: securityCriticalityFactor.value,
            securityTimingFactor: securityTimingFactor.value,
            securityBusinessScaleFactor: securityBusinessScaleFactor.value,
            costOptimizationTimingFactor: costOptimizationTimingFactor.value,
            costOptimizationBusinessScaleFactor: costOptimizationBusinessScaleFactor.value,
            costOptimizationBusinessScaleLimit: costOptimizationBusinessScaleLimit.value,
            performanceReliabilitySeverityFactor: performanceReliabilitySeverityFactor.value,
            performanceReliabilityTimingFactor: performanceReliabilityTimingFactor.value,
            performanceReliabilityBusinessScaleFactor: performanceReliabilityBusinessScaleFactor.value,
            dataEngineeringSeverityFactor: dataEngineeringSeverityFactor.value,
            dataEngineeringTimingFactor: dataEngineeringTimingFactor.value,
            dataEngineeringBusinessScaleFactor: dataEngineeringBusinessScaleFactor.value
          }
        });
        saveHistoryToLocalStorage();
        restoreState(lastState);
        saveStateToFirestore();
      }
    }

    function redo() {
      if (redoStack.length > 0) {
        const nextState = redoStack.pop();
        historyStack.push({
          entries: JSON.parse(JSON.stringify(entries)),
          parameters: JSON.parse(JSON.stringify(parameters)),
          valueMappers: JSON.parse(JSON.stringify(valueMappers)),
          factors: {
            clientExperienceCriticalityFactor: clientExperienceCriticalityFactor.value,
            clientExperienceTimingFactor: clientExperienceTimingFactor.value,
            clientExperienceBusinessScaleFactor: clientExperienceBusinessScaleFactor.value,
            productDeliveryCriticalityFactor: productDeliveryCriticalityFactor.value,
            productDeliveryTimingFactor: productDeliveryTimingFactor.value,
            productDeliveryBusinessScaleFactor: productDeliveryBusinessScaleFactor.value,
            productDeliveryBusinessScaleLimit: productDeliveryBusinessScaleLimit.value,
            securityCriticalityFactor: securityCriticalityFactor.value,
            securityTimingFactor: securityTimingFactor.value,
            securityBusinessScaleFactor: securityBusinessScaleFactor.value,
            costOptimizationTimingFactor: costOptimizationTimingFactor.value,
            costOptimizationBusinessScaleFactor: costOptimizationBusinessScaleFactor.value,
            costOptimizationBusinessScaleLimit: costOptimizationBusinessScaleLimit.value,
            performanceReliabilitySeverityFactor: performanceReliabilitySeverityFactor.value,
            performanceReliabilityTimingFactor: performanceReliabilityTimingFactor.value,
            performanceReliabilityBusinessScaleFactor: performanceReliabilityBusinessScaleFactor.value,
            dataEngineeringSeverityFactor: dataEngineeringSeverityFactor.value,
            dataEngineeringTimingFactor: dataEngineeringTimingFactor.value,
            dataEngineeringBusinessScaleFactor: dataEngineeringBusinessScaleFactor.value
          }
        });
        saveHistoryToLocalStorage();
        restoreState(nextState);
        saveStateToFirestore(); // Save state to local storage
      }
    }

    function restoreState(state) {
      entries = state.entries;
      parameters = state.parameters;
      valueMappers = state.valueMappers;
      clientExperienceCriticalityFactor.value = state.factors.clientExperienceCriticalityFactor;
      clientExperienceTimingFactor.value = state.factors.clientExperienceTimingFactor;
      clientExperienceBusinessScaleFactor.value = state.factors.clientExperienceBusinessScaleFactor;
      productDeliveryCriticalityFactor.value = state.factors.productDeliveryCriticalityFactor;
      productDeliveryTimingFactor.value = state.factors.productDeliveryTimingFactor;
      productDeliveryBusinessScaleFactor.value = state.factors.productDeliveryBusinessScaleFactor;
      productDeliveryBusinessScaleLimit.value = state.factors.productDeliveryBusinessScaleLimit;
      securityCriticalityFactor.value = state.factors.securityCriticalityFactor;
      securityTimingFactor.value = state.factors.securityTimingFactor;
      securityBusinessScaleFactor.value = state.factors.securityBusinessScaleFactor;
      costOptimizationTimingFactor.value = state.factors.costOptimizationTimingFactor;
      costOptimizationBusinessScaleFactor.value = state.factors.costOptimizationBusinessScaleFactor;
      costOptimizationBusinessScaleLimit.value = state.factors.costOptimizationBusinessScaleLimit;
      performanceReliabilitySeverityFactor.value = state.factors.performanceReliabilitySeverityFactor;
      performanceReliabilityTimingFactor.value = state.factors.performanceReliabilityTimingFactor;
      performanceReliabilityBusinessScaleFactor.value = state.factors.performanceReliabilityBusinessScaleFactor;
      dataEngineeringSeverityFactor.value = state.factors.dataEngineeringSeverityFactor;
      dataEngineeringTimingFactor.value = state.factors.dataEngineeringTimingFactor;
      dataEngineeringBusinessScaleFactor.value = state.factors.dataEngineeringBusinessScaleFactor;
      populateDescriptionFields();
      populateParameterFields();
      updateFactorValues();
      displayPermutationTable();
      sortEntriesTable();
      calculateScore();
    }

    document.addEventListener('keydown', function(event) {
      if ((event.ctrlKey || event.metaKey) && event.key === 'z' && !document.activeElement.matches('input, select, textarea')) {
        if (event.shiftKey) {
          event.preventDefault();
          redo();
        } else {
          event.preventDefault();
          undo();
        }
      }
    });

    function resetParameters() {
      saveToHistory();
      if (confirm('Are you sure you want to reset parameters to default?')) {
        parameters = {
          showstopper: ['No Impact', 'Not Critical', 'Low Criticality', 'Moderate Criticality', 'High Criticality', 'Total Stop'],
          frequency: ['Once in 5 Years', 'Once a Year or Less', 'Every 6 Months', 'Monthly', 'Weekly', 'Daily'],
          timeSpent: ['No Time Spent', 'Less than 1 hour', 'Less than 2 hours', 'Half a day', 'Full day', 'Overtime'],
          dealbreaker: ['No Impact', 'Not Critical', 'Low Priority', 'Medium Priority', 'High Priority', 'Must Have'],
          projectTime: ['2 Years', '1 Year', '6 Months', '1 Month', '1 Week', '1 Day'],
          companyShutdown: ['No Impact', 'No Impact', 'Low Impact', 'Moderate Impact', 'High Impact', 'Total Shutdown'],
          likelihood: ['Never', 'Very Unlikely', 'Unlikely', 'Possible', 'Likely', 'Very Likely'],
          // costReduction: ['No Reduction', 'Minimal Reduction', 'Low Reduction', 'Moderate Reduction', 'High Reduction', 'Maximum Reduction'],
          implementationTime: ['2 Years', '1 Year', '6 Months', '1 Month', '1 Week', '1 Day'],
          severity: ['No Degradation', 'Minimal Degradation', 'Low Degradation', 'Moderate Degradation', 'High Degradation', 'Total Downtime'],
          developmentTime: ['2 Years', '1 Year', '6 Months', '1 Month', '1 Week', '1 Day'],
          dataEngineeringSeverity: ['Minor Change', 'Slow Query', 'Incorrect Calculation', 'Data Loss', 'Data Corruption', 'Total Data Loss'],
          dataEngineeringDevelopmentTime: ['2 Years', '1 Year', '6 Months', '1 Month', '1 Week', '1 Day']
        };

        valueMappers = {
          showstopper: [0, 1, 2, 3, 4, 5],
          frequency: [0, 1, 2, 3, 4, 5],
          timeSpent: [0, 1, 2, 3, 4, 5],
          dealbreaker: [0, 1, 2, 3, 4, 5],
          projectTime: [0, 1, 2, 3, 4, 5],
          companyShutdown: [0, 1, 2, 3, 4, 5],
          likelihood: [0, 1, 2, 3, 4, 5],
          costReduction: [0, 1, 2, 3, 4, 5],
          implementationTime: [0, 1, 2, 3, 4, 5],
          severity: [0, 1, 2, 3, 4, 5],
          developmentTime: [0, 1, 2, 3, 4, 5],
          dataEngineeringSeverity: [0, 1, 2, 3, 4, 5],
          dataEngineeringDevelopmentTime: [0, 1, 2, 3, 4, 5]
        };

        populateDescriptionFields();
        populateDropdowns();
        displayPermutationTable();
        sortEntriesTable();
        calculateScore();
        checkStateDifference();
      }
    }

  // Load history from local storage on page load
  loadHistoryFromLocalStorage();

  // Function to save entries to Firestore
  async function saveEntriesToFirestore(namespace = "default") {
    if (!auth.currentUser) {
      console.log("User not logged in");
      entries = [];
      sortEntriesTable();
      return;
    }
    try {
      for (const entry of entries) {
        const entriesCollection = collection(db, "entries", entry.namespace, "data");
        const entryRef = doc(entriesCollection, entry.id);
        await setDoc(entryRef, entry);
      }
      console.log("Entries saved to Firestore");
    } catch (error) {
      if (error.code === 'permission-denied') {
        alert('You do not have permission to perform this action.');
        // Retract the action by reloading the entries from Firestore
        await loadEntriesFromFirestore(namespace);
      } else {
        console.error('Error saving entries to Firestore:', error);
      }
    }
  }

  // Function to load entries from Firestore
  async function loadEntriesFromFirestore(namespaces = ["default"]) {
    if (!auth.currentUser) {
      console.log("User not logged in");
      entries = [];
      sortEntriesTable();
      return;
    }
    entries = [];
    try {
      for (const namespace of namespaces) {
        const entriesCollection = collection(db, "entries", namespace, "data");
        const querySnapshot = await getDocs(entriesCollection);
        entries.push(...querySnapshot.docs.map(doc => ({ ...doc.data(), namespace })));
      }
    } catch (error) {
      if (error.code === 'permission-denied') {
        alert('You do not have permission to access data for one or more namespaces.');
      } else {
        console.error('Error loading entries from Firestore:', error);
      }
    }
    sortEntriesTable();
    checkStateDifference();
    console.log("Entries loaded from Firestore");
  }

  filterInput.addEventListener('input', filterEntries);
  categoryFilter.addEventListener('change', filterEntries);
  criticalityFilter.addEventListener('change', filterEntries);
  timingFilter.addEventListener('change', filterEntries);
  businessScaleFilter.addEventListener('change', filterEntries);

  toggleFiltersButton.addEventListener('click', () => {
    const isVisible = filtersRow.style.display !== 'none';
    filtersRow.style.display = isVisible ? 'none' : 'flex';
    toggleFiltersButton.innerText = isVisible ? 'Show Filters' : 'Hide Filters';
  });

  clearCategoryFilter.addEventListener('click', () => {
    categoryFilter.selectedIndex = -1;
    filterEntries();
  });

  clearCriticalityFilter.addEventListener('click', () => {
    criticalityFilter.selectedIndex = -1;
    filterEntries();
  });

  clearTimingFilter.addEventListener('click', () => {
    timingFilter.selectedIndex = -1;
    filterEntries();
  });

  clearBusinessScaleFilter.addEventListener('click', () => {
    businessScaleFilter.selectedIndex = -1;
    filterEntries();
  });

  clearAllFiltersButton.addEventListener('click', () => {
    filterInput.value = '';
    categoryFilter.selectedIndex = -1;
    criticalityFilter.selectedIndex = -1;
    timingFilter.selectedIndex = -1;
    businessScaleFilter.selectedIndex = -1;
    filterEntries();
  });

  loadNamespaceButton.addEventListener('click', async () => {
    const namespace = namespaceInput.value.trim();
    const namespaceFromURL = new URLSearchParams(window.location.search).get('namespace');
    if (namespace) {
      const namespaces = namespace.split(',').map(ns => ns.trim());
      await loadEntriesFromFirestore(namespaces);
      listenForEntriesChanges(namespaces);
      sortEntriesTable();
      loadNamespaceButton.disabled = namespace === namespaceFromURL;
      updateURL(null, null, null, null, namespace);
    }
  });

  namespaceInput.addEventListener('input', () => {
    const namespace = new URL(window.location).searchParams.get('namespace');
    loadNamespaceButton.disabled = namespaceInput.value.trim() === namespace;
  });

  namespaceInput.addEventListener('keypress', async (event) => {
    if (event.key === 'Enter') {
      const namespace = namespaceInput.value.trim();
      const namespaceFromURL = new URLSearchParams(window.location.search).get('namespace');
      if (namespace && namespace !== namespaceFromURL) {
        const namespaces = namespace.split(',').map(ns => ns.trim());
        await loadEntriesFromFirestore(namespaces);
        listenForEntriesChanges(namespaces);
        loadNamespaceButton.disabled = namespace === namespaceFromURL;
        updateURL(null, null, null, null, namespace);
      }
    }
  });

  // Initial state of the loadNamespaceButton
  loadNamespaceButton.disabled = true;

  function filterEntries() {
    const filterValue = filterInput.value.toLowerCase();
    const selectedCategories = Array.from(categoryFilter.selectedOptions).map(option => option.value);
    const selectedCriticalities = Array.from(criticalityFilter.selectedOptions).map(option => parseInt(option.value));
    const selectedTimings = Array.from(timingFilter.selectedOptions).map(option => parseInt(option.value));
    const selectedBusinessScales = Array.from(businessScaleFilter.selectedOptions).map(option => parseInt(option.value));
    const selectedStatuses = Array.from(statusFilter.selectedOptions).map(option => option.value);

    const filteredEntries = entries.filter(entry => {
      const entryTimingValue = calculateTimingValue(entry);
      return (filterValue === '' || entry.description.toLowerCase().includes(filterValue) ||
              entry.category.toLowerCase().includes(filterValue) ||
              entry.criticality.toLowerCase().includes(filterValue) ||
              entry.timing.toLowerCase().includes(filterValue) ||
              entry.businessScale.toString().toLowerCase().includes(filterValue) ||
              entry.score.toString().toLowerCase().includes(filterValue) ||
              entry.priorityLevel.toLowerCase().includes(filterValue)) &&
             (selectedCategories.length === 0 || selectedCategories.includes(entry.category)) &&
             (selectedCriticalities.length === 0 || selectedCriticalities.includes(Math.floor(parseInt(entry.criticality.split(' ')[0])))) &&
             (selectedTimings.length === 0 || selectedTimings.includes(Math.floor(entryTimingValue))) &&
             (selectedBusinessScales.length === 0 || selectedBusinessScales.includes(Math.floor(parseInt(entry.businessScale)))) &&
             (selectedStatuses.length === 0 || selectedStatuses.includes(entry.status));
    });

    renderEntriesTable(filteredEntries);

    // Update URL with filters
    const filters = {
      filter: filterInput.value,
      category: categoryFilter.value,
      criticality: criticalityFilter.value,
      timing: timingFilter.value,
      businessScale: businessScaleFilter.value,
      status: selectedStatuses.join(',')
    };
    updateURL(null, null, null, null, null, filters);
  }

  // Add event listeners for filters
  filterInput.addEventListener('input', filterEntries);
  categoryFilter.addEventListener('change', filterEntries);
  criticalityFilter.addEventListener('change', filterEntries);
  timingFilter.addEventListener('change', filterEntries);
  businessScaleFilter.addEventListener('change', filterEntries);
  statusFilter.addEventListener('change', filterEntries);

  // Initial call to filter entries
  filterEntries();

  function calculateTimingValue(entry) {
    const category = entry.category.toLowerCase().replace(/[\s&]+/g, '');
    if (category === 'clientexperience') {
      const frequencyValue = findClosestValue(valueMappers.frequency, entry.timing.split(' | ')[0], parameters.frequency);
      const timeSpentValue = findClosestValue(valueMappers.timeSpent, entry.timing.split(' | ')[1], parameters.timeSpent);
      return Math.round((frequencyValue + timeSpentValue) / 2);
    } else if (category === 'costoptimization') {
      return findClosestValue(valueMappers.implementationTime, entry.timing, parameters.implementationTime);
    } else {
      return findClosestValue(valueMappers.projectTime, entry.timing, parameters.projectTime);
    }
  }

  function isValueInRange(value, range) {
    if (range.length === 0) return true;
    const min = Math.min(...range);
    const max = Math.max(...range);
    return value >= min && value <= max;
  }

  function updateEntryStatus(id, status) {
    const entry = entries.find(entry => entry.id === id);
    if (entry) {
      entry.status = status;
      saveEntriesToLocalStorage();
      filterEntries();
    }
  }

  function updateNamespaceSelect() {
    const namespaceParam = new URLSearchParams(window.location.search).get('namespace');
    const namespaces = namespaceParam ? namespaceParam.split(',').map(ns => ns.trim()) : ['default'];
    const namespaceSelectContainer = document.getElementById('namespaceSelectContainer');
    const namespaceSelect = document.getElementById('namespaceSelect');

    if (namespaces.length > 1) {
      namespaceSelectContainer.style.display = 'block';
      namespaceSelect.innerHTML = namespaces.map(ns => `<option value="${ns}">${ns}</option>`).join('');
    } else {
      namespaceSelectContainer.style.display = 'none';
    }

    // Show/hide namespace header
    const namespaceHeader = document.getElementById('namespace-header');
    if (namespaces.length > 1) {
      namespaceHeader.style.display = 'table-cell';
    } else {
      namespaceHeader.style.display = 'none';
    }
  }

  // Initial call to update namespace select
  updateNamespaceSelect();

  </script>

</body>
</html>